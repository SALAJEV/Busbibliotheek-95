<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Busbibliotheek Live</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
  margin:0;
  font-family:Inter,sans-serif;
  background:#f9fafb;
}
.container {
  max-width:1200px;
  margin:2rem auto;
  padding:1rem;
}
.grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:1rem;
}
.card {
  background:#fff;
  padding:1rem;
  border-radius:1rem;
}
input,button {
  width:100%;
  padding:1rem;
  margin-top:.5rem;
}
table {
  width:100%;
  border-collapse:collapse;
}
th,td {
  padding:.5rem;
  border-bottom:1px solid #ccc;
}
#map {
  height:300px;
  margin-top:1rem;
  border-radius:1rem;
}
</style>
</head>

<body>
<div class="container">

<h1>üöå Busbibliotheek Live</h1>

<input id="input" placeholder="Voertuignummer / Hansea / oud nummer">
<button onclick="zoek()">Zoeken</button>

<div class="grid">
  <div class="card">
    <h2>Voertuiginfo</h2>
    <div id="vaste">‚Äì</div>
  </div>

  <div class="card">
    <h2>Realtime</h2>
    <div id="rt">‚Äì</div>
    <div id="map"></div>
  </div>
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let voertuigen = [];
let map, marker, timer;

/* ==== LOAD VEHICLES ==== */
async function laadVoertuigen() {
  const res = await fetch(
    "https://pub-611b5bc156eb455ba86d9bcece9aea1c.r2.dev/vehicles.txt",
    { cache:"no-store" }
  );
  const text = await res.text();
  const lines = text.trim().split("\n");

  const headers = lines[0].split(";").map(h =>
    h.replace(/\ufeff/g,"").trim()
  );

  voertuigen = lines.slice(1).map(line => {
    const vals = line.split(";");
    const obj = {};
    headers.forEach((h,i)=>obj[h]=vals[i]?.trim()||"");
    return obj;
  });
}
laadVoertuigen();

/* ==== SEARCH ==== */
function zoek(){
  const q = input.value.trim().toLowerCase();
  if(!q) return;

  const bus = voertuigen.find(v =>
    v["Voertuignummer"]?.toLowerCase() === q ||
    v["Hansea nummer"]?.toLowerCase() === q ||
    v["Oude voertuignummers"]?.toLowerCase().split(/[, ]+/).includes(q) ||
    v["Oude nummerplaten"]?.toLowerCase().split(/[, ]+/).includes(q)
  );

  if(!bus){
    vaste.innerHTML = "‚ùå Geen voertuig gevonden.";
    return;
  }

  /* vaste data */
  let html="<table>";
  Object.entries(bus).forEach(([k,v])=>{
    if(v && v!=="/")
      html+=`<tr><th>${k}</th><td>${v}</td></tr>`;
  });
  html+="</table>";
  vaste.innerHTML=html;

  /* realtime starten met ECHT voertuignummer */
  startRealtime(bus["Voertuignummer"]);
}

/* ==== MAP ==== */
function initMap(lat,lon){
  map=L.map("map").setView([lat,lon],14);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
}

/* ==== REALTIME ==== */
async function startRealtime(vehicleId){
  if(timer) clearInterval(timer);
  await updateRealtime(vehicleId);
  timer=setInterval(()=>updateRealtime(vehicleId),10000);
}

async function updateRealtime(vehicleId){
  try{
    const res=await fetch("https://busbibliotheek95.pages.dev/api");
    const data=await res.json();

    const gps=[...data.entity]
      .reverse()
      .find(e =>
        e.vehicle?.vehicle?.id == vehicleId &&
        e.vehicle?.position
      );

    if(!gps){
      rt.innerHTML="Geen realtime data voor dit voertuig.";
      return;
    }

    const p=gps.vehicle.position;
    rt.innerHTML=`Lat ${p.latitude}<br>Lon ${p.longitude}`;

    if(!map) initMap(p.latitude,p.longitude);
    map.setView([p.latitude,p.longitude],15);

    if(marker) marker.setLatLng([p.latitude,p.longitude]);
    else marker=L.marker([p.latitude,p.longitude]).addTo(map);

  }catch(e){
    rt.innerHTML="Realtime fout.";
  }
}
</script>
</body>
</html>