<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Zoek een voertuig en volg 'm live.">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Busbibliotheek">
<link rel="apple-touch-icon" href="logo.png">
<link rel="manifest" href="manifest.json">
<title>Busbibliotheek</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
/* ===============================
   THEME VARIABLES
================================ */
:root {
  --blur: 14px;
  --radius: 18px;

  --bg: #f2f4f8;
  --glass-bg: rgba(255, 255, 255, 0.55);
  --border: rgba(255, 255, 255, 0.35);

  --text: #1f2937;
  --muted: #6b7280;
  --accent: #2563eb;
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0f1115;
    --glass-bg: rgba(20,22,28,0.6);
    --border: rgba(255,255,255,0.08);

    --text: #e5e7eb;
    --muted: #9ca3af;
    --accent: #38bdf8;
  }
}

/* ===============================
   BASE
================================ */
* { box-sizing: border-box; margin:0; padding:0; }

body {
  min-height: 100vh;
  font-family: "Inter", system-ui, sans-serif;
  background: radial-gradient(circle at top, rgba(255,255,255,0.15), transparent 60%), var(--bg);
  color: var(--text);
}

.container {
  max-width: 1100px;
  margin: auto;
  padding: 2rem 1.5rem 3rem;
}

h1 { font-size: 2.4rem; margin-bottom: 0.3rem; }
p { margin-top: 0.2rem; color: var(--muted); }

/* ===============================
   INPUT + BUTTON
================================ */
input {
  width: 100%;
  padding: 0.9rem 1rem;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur));
  color: var(--text);
  font-size: 1rem;
  outline: none;
  margin-bottom: 0.3rem;
}

input::placeholder { color: var(--muted); }

button {
  margin-top: 0.8rem;
  padding: 0.85rem 1.4rem;
  border-radius: var(--radius);
  border: none;
  background: linear-gradient(135deg, var(--accent), #60a5fa);
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
}

button:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
}

/* ===============================
   SUGGESTIELIJST
================================ */
#suggestielijst {
  list-style: none;
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 1rem;
}

#suggestielijst li {
  padding: 0.7rem 1rem;
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur));
  border-bottom: 1px solid var(--border);
  cursor: pointer;
}

#suggestielijst li:hover { background: rgba(255,255,255,0.15); }

/* ===============================
   GRID
================================ */
.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  margin-top: 2rem;
  opacity: 0;
  transform: translateY(20px);
  transition: 0.5s;
  position: relative;
}

.grid.show { opacity: 1; transform: translateY(0); }

@media (max-width: 900px) {
  .grid { grid-template-columns: 1fr; }
}

/* ===============================
   CARD
================================ */
.card {
  display: flex;
  flex-direction: column;
  padding: 1.4rem 1.5rem;
  border-radius: var(--radius);
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur)) saturate(150%);
  border: 1px solid var(--border);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), 0 20px 40px rgba(0,0,0,0.15);
  min-height: 320px;
}

.card h2 { margin-bottom: 0.8rem; }

/* ===============================
   TABLE
================================ */
table { width: 100%; border-collapse: collapse; }
th { text-align: left; color: var(--muted); font-weight: 600; padding: 0.4rem 0; width: 40%; }
td { padding: 0.4rem 0; }
.voertuignummer-display { font-size: 1.5rem; font-weight: 700; margin-bottom: .5rem; }

/* ===============================
   MAP
================================ */
#map {
  margin-top: 0.8rem;
  height: 300px;
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid var(--border);
}

.leaflet-container { background: #000; border-radius: var(--radius); }

/* Dark mode: lighter tile layer for Leaflet */
@media (prefers-color-scheme: dark) {
  .leaflet-tile-pane { filter: invert(0.8) hue-rotate(180deg) brightness(1.1); opacity: 0.9; }
}

/* Hide map when no data */
#map.hidden { display: none; }

/* Delay status styling */
.delay-status {
  font-weight: 600;
  margin-top: 0.4rem;
}
.delay-early { color: #dc2626; }
.delay-ontime { color: var(--text); }
.delay-late { color: #257beb; }

/* ===============================
   BUTTON CLOSE
================================ */
.close-btn {
  position: absolute;
  top: 0;
  right: 0;
  background: none;
  border: none;
  font-size: 1.8rem;
  color: var(--text);
  cursor: pointer;
  padding: 0.5rem 1rem;
  margin-top: 0 !important;
  transition: transform 0.15s ease, color 0.15s ease;
}
.close-btn:hover {
  transform: scale(1.1);
  color: var(--accent);
  box-shadow: none;
}

/* ===============================
   LOADING SPINNER
================================ */
.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(0,0,0,0.1);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  vertical-align: middle;
  margin-right: 8px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-pulse {
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ===============================
   LOADING
================================ */
.loading { color: #888; font-style: italic; }
</style>
</head>
<body>
<div class="container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
      <h1>Busbibliotheek</h1>
      <p>Zoekt een voertuig op en volg het in realtime.</p>
    </div>
  </div>

  <input id="voertuignummer" placeholder="Voertuignummer" 
         oninput="toonSuggesties()" 
         onkeydown="if(event.key==='Enter'){zoekAlles();}" autocomplete="off">
  <ul id="suggestielijst"></ul>

  <div class="grid" id="resultsGrid">
    <button class="close-btn" id="closeBtn" style="display:none; position: absolute; top: 2rem; right: 1.5rem; z-index: 100;" onclick="terug()" title="Venster sluiten" aria-label="Sluiten">×</button>
    <div class="card">
      <h2>Voertuiginformatie</h2>
      <div id="vasteData">Geen voertuig geselecteerd.</div>
    </div>

    <div class="card">
      <h2>Realtimegegevens</h2>
      <div id="realtime" class="loading">Geen gegevens beschikbaar.</div>
      <div id="map"></div>
    </div>
  </div>

  <footer style="margin-top: 4rem; padding: 2rem; border-top: 1px solid var(--border); color: var(--muted); font-size: 0.9rem;">
    <h3>Disclaimer</h3>
    <p style="margin-top: 0.5rem; line-height: 1.6;">De informatie op deze website wordt verstrekt zonder garanties. Busbibliotheek is niet aansprakelijk voor vertraging, fouten of onnauwkeurigheden in realtime gegevens. Gebruikers raadplegen deze informatie geheel op eigen risico. Raadpleeg voor officiële ritinformatie de bevoegde vervoersmaatschappij.</p>
  </footer>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Constants
const BASE_URL = "https://pub-611b5bc156eb455ba86d9bcece9aea1c.r2.dev";
const API_URL = "https://busbibliotheek95.pages.dev/api";
const TIME_UPDATE = 10000; // 10 seconds

let voertuigen = [];
let trips = [];
let routes = [];
let map, marker, refresh;
let userInteracted = false;
let centerControl;

// Helper: CSV parser that respects quoted fields
function parseCSVLine(line){
  const fields = [];
  let cur = "";
  let inQuotes = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"') { cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if(ch === ',' && !inQuotes){
      fields.push(cur);
      cur = "";
    } else { cur += ch; }
  }
  fields.push(cur);
  return fields.map(f => f.trim().replace(/^"|"$/g, ''));
}

// Helper: normalize ids/strings for matching
const normalize = s => (s||"").toString().replace(/"/g, "").trim();

// Custom bus pin as DivIcon so we can rotate the image based on bearing
const busIcon = L.divIcon({
  className: 'bus-div-icon',
  html: `<img src="navicon.png" style="width:36px;height:36px;transform:rotate(0deg);display:block;transform-origin:18px 28px;transition: transform 0.25s linear;"/>`,
  iconSize: [36,36],
  iconAnchor: [18,36]
});

async function laadVoertuigen() {
  const res = await fetch(`${BASE_URL}/vehicles.txt`, { cache: "no-store" });
  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = regels[0].split(";");

  voertuigen = regels.slice(1).map(r => {
    const v = r.split(";");
    const obj = {};
    headers.forEach((h,i)=>obj[h.trim()] = v[i]?.trim() || "/");
    return obj;
  });
}

async function laadTrips() {
  const res = await fetch(`${BASE_URL}/trips.txt`, { cache: "no-store" });
  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = parseCSVLine(regels[0]).map(h => h.trim());

  trips = regels.slice(1).map(r => {
    const values = parseCSVLine(r);
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i] || "/");
    return obj;
  });
}

async function laadRoutes() {
  const res = await fetch(`${BASE_URL}/routes.txt`, { cache: "no-store" });
  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = parseCSVLine(regels[0]).map(h => h.trim());

  routes = regels.slice(1).map(r => {
    const values = parseCSVLine(r);
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i] || "/");
    return obj;
  });
}

laadVoertuigen();
laadTrips();
laadRoutes();

function toonSuggesties() {
  const q = voertuignummer.value.toLowerCase();
  suggestielijst.innerHTML = "";
  if(!q) return;

  voertuigen.filter(v => v.Voertuignummer?.toLowerCase().startsWith(q))
    .slice(0,8)
    .forEach(v=>{
      const li=document.createElement("li");
      li.textContent = `${v.Voertuignummer} – ${v.Type}`;
      li.onclick=()=>{
        voertuignummer.value=v.Voertuignummer;
        suggestielijst.innerHTML="";
        voertuignummer.blur(); // Focus weghalen zodat geen enter meer nodig is
        zoekAlles();
      };
      suggestielijst.appendChild(li);
    });
}

function zoekAlles() {
  const id = voertuignummer.value.trim();
  if(!id) return;

  suggestielijst.innerHTML = "";
  document.getElementById("resultsGrid").classList.add("show");
  document.getElementById("closeBtn").style.display = "block";

  toonVasteData(id);

  realtime.innerHTML = "<span class='spinner'></span><span class='loading'>Gegevens laden...</span>";

  updateRealtime(id);
  if(refresh) clearInterval(refresh);
  refresh = setInterval(()=>updateRealtime(id), TIME_UPDATE);
}

function terug() {
  document.getElementById("resultsGrid").classList.remove("show");
  document.getElementById("closeBtn").style.display = "none";
  realtime.innerHTML = "Geen gegevens beschikbaar.";
  vasteData.innerHTML = "Geen voertuig geselecteerd.";
  voertuignummer.value = "";
  if(marker){ map.removeLayer(marker); marker=null; }
}

function toonVasteData(id){
  const bus = voertuigen.find(v =>
    v.Voertuignummer===id ||
    v["Hansea nummer"]===id ||
    v["Oude voertuignummers"]?.split(/[, ]+/).includes(id) ||
    v["Oude nummerplaten"]?.split(/[, ]+/).includes(id)
  );

  if(!bus){
    vasteData.innerHTML="Geen voertuiggegevens gevonden.";
    return;
  }

  let html=`<p class="voertuignummer-display">${bus.Voertuignummer}</p>`;
  if(bus.Type) html += `<p style="font-size:1.1rem;font-weight:700;color:var(--text);margin-bottom:0.8rem;">${bus.Type}</p>`;
  html+="<table>";
  for(const [k,v] of Object.entries(bus)){
    if(k==="Vervoersmaatschappij"||k==="Voertuignummer"||k==="Type") continue;

    let waarde = v;
    const key = k.toLowerCase();

    if(key.includes("datum in dienst") && v!=="/") {
      waarde = new Date(v).toLocaleDateString("nl-NL",{year:'numeric',month:'long',day:'numeric'});
    } else if(key.includes("uit dienst")) {
      if(v==="/") waarde = "Niet uit dienst";
      else waarde = new Date(v).toLocaleDateString("nl-NL",{year:'numeric',month:'long',day:'numeric'});
    } else if(key.includes("datum") && v!=="/") {
      waarde = new Date(v).toLocaleDateString("nl-NL",{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    } else {
      if(v==="/") continue;
    }
    html+=`<tr><th>${k}</th><td>${waarde}</td></tr>`;
  }
  html+="</table>";
  const igUrl = 'https://www.instagram.com/explore/search/keyword/?q=' + encodeURIComponent('#dl' + id);
  html += `<p class="ig-btn-wrap"><a class="btn btn--instagram" href="${igUrl}" target="_blank" rel="noopener">Zoek op Instagram</a></p>`;
  vasteData.innerHTML=html;
}

function initMap(lat,lon){
  if(!map){
    map=L.map("map").setView([lat,lon],14);

    // Cleaner base map suitable for transit (CartoDB Positron)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors &amp; <a href="https://carto.com/">CARTO</a>'
    }).addTo(map);

    // Optional transport overlay (rail/lines) - may enhance transit visualization
    const transportOverlay = L.tileLayer('https://a.tile.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenRailwayMap'
    });
    transportOverlay.addTo(map);

    // Detect user interactions to stop auto-centering
    map.on('dragstart zoomstart movestart touchstart', ()=>{
      userInteracted = true;
      if(centerControl) centerControl.getContainer().style.display = 'block';
    });

    // Create a custom control (button) to re-center the map
    const CenterControl = L.Control.extend({
      onAdd: function(map){
        const el = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const btn = L.DomUtil.create('a', '', el);
        btn.innerHTML = 'C';
        btn.title = 'Centreren';
        btn.href = '#';
        btn.style.display = 'none';
        btn.style.width = '30px';
        btn.style.height = '30px';
        btn.style.lineHeight = '30px';
        btn.style.textAlign = 'center';
        btn.style.fontWeight = '700';
        btn.style.background = 'white';
        btn.style.color = '#333';
        btn.style.textDecoration = 'none';

        L.DomEvent.on(btn, 'click', L.DomEvent.stopPropagation)
                 .on(btn, 'click', L.DomEvent.preventDefault)
                 .on(btn, 'click', ()=>{
                   if(marker){
                     map.setView(marker.getLatLng(), Math.max(map.getZoom(), 15));
                     userInteracted = false;
                     btn.style.display = 'none';
                   }
                 });

        return el;
      }
    });

    centerControl = new CenterControl({ position: 'topright' });
    centerControl.addTo(map);
  }
}

async function updateRealtime(id){
  try{
    const res = await fetch(API_URL);
    const data = await res.json();

    const gps = data.entity.reverse().find(e=>e.vehicle?.vehicle?.id==id && e.vehicle.position);

    if(!gps){ realtime.innerHTML="Geen realtimegegevens beschikbaar."; document.getElementById("map").classList.add("hidden"); return; }

    const v=gps.vehicle;
    const tripid = gps.vehicle.trip?.tripId || gps.vehicle.trip?.trip_id || "Geen trip";

    // Zorg dat trips/routes geladen zijn
    if(trips.length===0) await laadTrips();
    if(routes.length===0) await laadRoutes();

    // Robuuste matching: normaliseer en probeer exact / endsWith / includes
    const nTripId = normalize(tripid);
    let tripData = trips.find(t => normalize(t.trip_id) === nTripId);
    if(!tripData && nTripId){
      tripData = trips.find(t => {
        const tId = normalize(t.trip_id);
        return tId && (
          tId === nTripId ||
          tId.endsWith(nTripId) ||
          nTripId.endsWith(tId) ||
          tId.includes(nTripId) ||
          nTripId.includes(tId)
        );
      });
    }
    

    const routeId = tripData?.route_id || "";
    let routeData = routes.find(r => r.route_id === routeId);
    if(!routeData && routeId){
      routeData = routes.find(r => r.route_id && (
        r.route_id === routeId ||
        r.route_id.includes(routeId) ||
        routeId.includes(r.route_id)
      ));
    }

    const routeShort = routeData?.route_short_name || "?";
    const routeLong = routeData?.route_long_name || "";
    const tripShort = tripData ? (tripData.trip_headsign || tripData.trip_short_name || "") : "";

    const msgDelay = delayMinutes < 0 ? `${Math.abs(delayMinutes)} minuut${Math.abs(delayMinutes)!==1?'en':''} te vroeg` 
                   : delayMinutes > 0 ? `${delayMinutes} minuut${delayMinutes!==1?'en':''} vertraging`
                   : "Op tijd";
    let delayClass = delayMinutes < 0 ? "delay-early" : delayMinutes > 0 ? "delay-late" : "delay-ontime";

    realtime.innerHTML=`
      <p>
        <b>Lijn:</b> ${routeShort}<br>
        <b>Bestemming:</b> ${tripShort}<br>
        <span class="delay-status ${delayClass}">${delayText}</span>
      </p>
    `;
    document.getElementById("map").classList.remove("hidden");

    initMap(v.position.latitude,v.position.longitude);
    // Always center the map on each realtime update
    map.setView([v.position.latitude,v.position.longitude],15);

    const bearing = v.position.bearing || 0;

    if(marker) {
      marker.setLatLng([v.position.latitude,v.position.longitude]);
      marker.setPopupContent(`Voertuig ${id}<br>Lijn ${routeShort}<br>Bestemming: ${tripShort}<br>Vertraging: ${delayText}`);
      // update rotation of img inside divIcon
      const el = marker.getElement && marker.getElement();
      if(el){
        const img = el.querySelector('img');
        if(img) img.style.transform = `rotate(${bearing}deg)`;
      }
    } else {
      marker = L.marker([v.position.latitude,v.position.longitude], { icon: busIcon })
        .addTo(map)
        .bindPopup(`Voertuig ${id}<br>Lijn ${routeShort}<br>Bestemming: ${tripShort}<br>Vertraging: ${delayText}`)
        .openPopup();
      // set initial rotation
      const el = marker.getElement && marker.getElement();
      if(el){
        const img = el.querySelector('img');
        if(img) img.style.transform = `rotate(${bearing}deg)`;
      }
    }

  }catch(e){ console.error(e); realtime.innerHTML="Fout bij ophalen van realtimegegevens."; }
}
</script>

<!-- Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .catch(err => console.error('Service Worker registratie mislukt:', err));
}
</script>
</body>
</html>