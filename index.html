<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Zoek een voertuig en volg 'm live.">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Busbibliotheek">
<link rel="apple-touch-icon" href="logo_light.png">
<link rel="manifest" href="manifest.json">
<title>Busbibliotheek</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
/* ===============================
   THEME VARIABLES
================================ */
:root {
  --blur: 14px;
  --radius: 18px;

  --bg: #f2f4f8;
  --glass-bg: rgba(255, 255, 255, 0.55);
  --border: rgba(255, 255, 255, 0.35);

  --text: #1f2937;
  --muted: #6b7280;
  --accent: #2563eb;
  --btn-text: #f8fafc;
  --btn-glass-1: rgba(37, 99, 235, 0.55);
  --btn-glass-2: rgba(30, 64, 175, 0.35);
  --btn-border: rgba(255, 255, 255, 0.35);
  --btn-shadow: 0 10px 26px rgba(15, 23, 42, 0.25);
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0f1115;
    --glass-bg: rgba(20,22,28,0.6);
    --border: rgba(255,255,255,0.08);

    --text: #e5e7eb;
    --muted: #9ca3af;
    --accent: #38bdf8;
    --btn-text: #e2e8f0;
    --btn-glass-1: rgba(56, 189, 248, 0.35);
    --btn-glass-2: rgba(14, 116, 144, 0.35);
    --btn-border: rgba(255, 255, 255, 0.2);
    --btn-shadow: 0 12px 28px rgba(2, 8, 23, 0.45);
  }
}

:root[data-theme="light"] {
  --bg: #f2f4f8;
  --glass-bg: rgba(255, 255, 255, 0.55);
  --border: rgba(255, 255, 255, 0.35);
  --text: #1f2937;
  --muted: #6b7280;
  --accent: #2563eb;
}

:root[data-theme="dark"] {
  --bg: #0f1115;
  --glass-bg: rgba(20,22,28,0.6);
  --border: rgba(255,255,255,0.08);
  --text: #e5e7eb;
  --muted: #9ca3af;
  --accent: #38bdf8;
}

/* ===============================
   BASE
================================ */
* { box-sizing: border-box; margin:0; padding:0; }

body {
  min-height: 100vh;
  font-family: "Inter", system-ui, sans-serif;
  background: radial-gradient(circle at top, rgba(255,255,255,0.15), transparent 60%), var(--bg);
  color: var(--text);
}

.container {
  max-width: 1100px;
  margin: auto;
  padding: 2rem 1.5rem 3rem;
}

h1 { font-size: 2.4rem; margin-bottom: 0.3rem; }
p { margin-top: 0.2rem; color: var(--muted); }

/* ===============================
   INPUT + BUTTON
================================ */
input {
  width: 100%;
  padding: 0.9rem 1rem;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur));
  color: var(--text);
  font-size: 1rem;
  outline: none;
  margin-bottom: 0.3rem;
}

input::placeholder { color: var(--muted); }

button,
.btn {
  margin-top: 0.8rem;
  padding: 0.85rem 1.4rem;
  border-radius: var(--radius);
  border: 1px solid var(--btn-border);
  background:
    linear-gradient(135deg, var(--btn-glass-1), var(--btn-glass-2)),
    radial-gradient(circle at 30% 20%, rgba(255,255,255,0.28), transparent 60%);
  backdrop-filter: blur(calc(var(--blur) * 0.85)) saturate(150%);
  -webkit-backdrop-filter: blur(calc(var(--blur) * 0.85)) saturate(150%);
  color: var(--btn-text);
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, filter 0.18s ease;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.35), var(--btn-shadow);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-height: 44px;
  min-width: 44px;
}

button:hover,
.btn:hover {
  transform: translateY(-2px);
  border-color: rgba(255,255,255,0.55);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.5), 0 14px 32px rgba(15, 23, 42, 0.3);
  filter: saturate(1.08);
}

button:active,
.btn:active {
  transform: translateY(0);
}

button:focus-visible,
.btn:focus-visible {
  outline: 2px solid rgba(255, 255, 255, 0.85);
  outline-offset: 2px;
}

/* ===============================
   SUGGESTIELIJST
================================ */
#suggestielijst {
  list-style: none;
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 1rem;
}

#suggestielijst li {
  padding: 0.7rem 1rem;
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur));
  border-bottom: 1px solid var(--border);
  cursor: pointer;
}

#suggestielijst li:hover { background: rgba(255,255,255,0.15); }

/* ===============================
   GRID
================================ */
.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  margin-top: 2rem;
  opacity: 0;
  transform: translateY(20px);
  transition: 0.5s;
  position: relative;
}

.grid.show { opacity: 1; transform: translateY(0); }

@media (max-width: 900px) {
  .grid { grid-template-columns: 1fr; }
}

/* ===============================
   CARD
================================ */
.card {
  display: flex;
  flex-direction: column;
  padding: 1.4rem 1.5rem;
  border-radius: var(--radius);
  background: var(--glass-bg);
  backdrop-filter: blur(var(--blur)) saturate(150%);
  border: 1px solid var(--border);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), 0 20px 40px rgba(0,0,0,0.15);
  min-height: 320px;
}

.card h2 { margin-bottom: 0.8rem; }

/* ===============================
   TABLE
================================ */
table { width: 100%; border-collapse: collapse; }
th { text-align: left; color: var(--muted); font-weight: 600; padding: 0.4rem 0; width: 40%; }
td { padding: 0.4rem 0; }
.voertuignummer-display { font-size: 1.5rem; font-weight: 700; margin-bottom: .5rem; }

/* ===============================
   MAP
================================ */
#map {
  margin-top: 0.8rem;
  height: 300px;
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid var(--border);
}

.leaflet-container { background: #000; border-radius: var(--radius); }
.leaflet-control a.map-center-btn {
  border-radius: 10px;
  border: 1px solid var(--btn-border);
  background: linear-gradient(135deg, var(--btn-glass-1), var(--btn-glass-2));
  color: var(--btn-text);
}

/* Dark mode: lighter tile layer for Leaflet */
@media (prefers-color-scheme: dark) {
  .leaflet-tile-pane { filter: invert(0.8) hue-rotate(180deg) brightness(1.1); opacity: 0.9; }
}

/* Hide map when no data */
#map.hidden { display: none; }

/* Delay status styling */
.delay-status {
  font-weight: 600;
  margin-top: 0.4rem;
}
.route-destination-row {
  display: flex;
  align-items: center;
  gap: 0.32rem;
  flex-wrap: wrap;
  margin-bottom: 0.15rem;
}
.line-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 2.1rem;
  padding: 0.18rem 0.55rem;
  border-radius: 2px;
  font-weight: 700;
  line-height: 1.2;
  letter-spacing: 0.01em;
}
.destination-text {
  font-weight: 700;
  color: var(--text);
  font-style: normal;
}
.delay-early { color: #dc2626; }
.delay-ontime { color: var(--text); }
.delay-late { color: #257beb; }

/* ===============================
   BUTTON CLOSE
================================ */
.close-btn {
  position: absolute;
  top: 0;
  right: 0;
  font-size: 1.35rem;
  line-height: 1;
  color: var(--btn-text);
  padding: 0.55rem 0.78rem;
  margin-top: 0 !important;
  border-radius: 999px;
}
.close-btn:hover {
  transform: scale(1.04);
}

/* ===============================
   LOADING SPINNER
================================ */
.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(0,0,0,0.1);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  vertical-align: middle;
  margin-right: 8px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-pulse {
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* ===============================
   LOADING
================================ */
.loading { color: #888; font-style: italic; }

/* ===============================
   SPLASH / LAADSCHERM
================================ */
#splash{
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background:
    radial-gradient(circle at 25% 20%, rgba(255,255,255,0.55), transparent 58%),
    linear-gradient(180deg, rgba(255,255,255,0.62), rgba(255,255,255,0.28)),
    var(--bg);
  z-index: 9999;
  padding: env(safe-area-inset);
  transition: opacity 0.42s ease, visibility 0.42s ease;
  will-change: opacity;
}
@media (prefers-color-scheme: dark) {
  #splash {
    background:
      radial-gradient(circle at 25% 20%, rgba(255,255,255,0.08), transparent 58%),
      linear-gradient(180deg, rgba(15,17,21,0.9), rgba(15,17,21,0.72)),
      var(--bg);
  }
}
#splash .logo{
  width: 44vw;
  max-width: 220px;
  height: auto;
  border-radius: 12px;
  background: transparent;
  padding: 10px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.25);
  transform: translateY(0) scale(1);
  animation: splashFloat 1.9s ease-in-out infinite;
  will-change: transform, opacity;
}
@media (min-width: 700px) {
  #splash .logo { width: 200px; }
}
#splash.hidden{ opacity: 0; visibility: hidden; pointer-events: none; }
#splash.hidden .logo { transform: translateY(-6px) scale(0.96); opacity: 0.45; }
@keyframes splashFloat {
  0%, 100% { transform: translateY(0) scale(1); }
  50% { transform: translateY(-5px) scale(1.015); }
}

/* ===============================
   INSTALL BUTTON
================================ */
#installBtn {
  margin-top: 0 !important;
  padding: 0.75rem 1.2rem;
  font-size: 0.95rem;
  display: none;
  white-space: nowrap;
  background:
    linear-gradient(135deg, rgba(5, 150, 105, 0.52), rgba(4, 120, 87, 0.38)),
    radial-gradient(circle at 30% 20%, rgba(255,255,255,0.25), transparent 60%);
}
#installBtn::before { content: "\2193 "; }
#installBtn.show { display: inline-flex; }

.btn--instagram {
  background:
    linear-gradient(45deg, rgba(250, 126, 30, 0.75), rgba(214, 41, 118, 0.72) 50%, rgba(79, 91, 213, 0.7)),
    radial-gradient(circle at 25% 20%, rgba(255,255,255,0.28), transparent 60%);
}

.btn--instagram::before {
  content: "IG ";
  font-weight: 700;
  margin-right: 0.25rem;
}

.header-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.ig-btn-wrap { margin-top: 0.9rem; }
.action-row {
  display: flex;
  gap: 0.7rem;
  margin-bottom: 0.8rem;
}

.stack-card {
  margin-top: 1rem;
  padding: 1rem;
  border-radius: 14px;
  background: var(--glass-bg);
  border: 1px solid var(--border);
  backdrop-filter: blur(var(--blur));
}

.stack-card h3 {
  margin-bottom: 0.65rem;
}

.chip-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.chip {
  margin-top: 0;
  padding: 0.45rem 0.75rem;
  min-height: 36px;
  border-radius: 999px;
  font-size: 0.88rem;
}

.hint {
  margin-top: 0.6rem;
  padding: 0.7rem 0.85rem;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(0,0,0,0.07);
  color: var(--muted);
  font-size: 0.92rem;
}

.settings-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 0.65rem;
}

.settings-grid label {
  font-size: 0.86rem;
  color: var(--muted);
  display: block;
  margin-bottom: 0.25rem;
}

.settings-grid select {
  width: 100%;
  padding: 0.55rem 0.65rem;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--glass-bg);
  color: var(--text);
}

.meta-row {
  display: flex;
  justify-content: space-between;
  gap: 0.7rem;
  margin-bottom: 0.5rem;
  flex-wrap: wrap;
}

#lastUpdate {
  color: var(--muted);
  font-size: 0.9rem;
}

@media (max-width: 900px) {
  .container { padding: 1.5rem 1rem 2rem; }
  h1 { font-size: 2rem; }
  .card { min-height: 280px; }
}

@media (max-width: 640px) {
  .header-bar { align-items: stretch; }
  #installBtn { width: 100%; }
  .btn,
  button:not(.close-btn) { width: 100%; }
  .action-row { flex-direction: column; }
  .settings-grid { grid-template-columns: 1fr; }
  #map { height: 260px; }
}

@media (prefers-reduced-motion: reduce) {
  * { animation-duration: 0.001ms !important; transition-duration: 0.001ms !important; }
}
</style>
</head>
<body>
<div id="splash" role="img" aria-label="Busbibliotheek laden">
  <picture class="logo">
    <source media="(prefers-color-scheme: light)" srcset="logo_light.png">
    <source media="(prefers-color-scheme: dark)" srcset="logo_dark.png">
    <img src="logo_light.png" alt="Busbibliotheek">
  </picture>
</div>
<div class="container">
  <div class="header-bar">
    <div>
      <h1 id="appTitle">Busbibliotheek</h1>
      <p id="appSubtitle">Zoekt een voertuig op en volg het in realtime.</p>
    </div>
    <button id="installBtn" title="App installeren op thuisscherm">Installeer App</button>
  </div>
  <div id="iosInstallHint" class="hint" hidden></div>

  <input id="voertuignummer" placeholder="Voertuignummer" 
         oninput="toonSuggesties()" 
         onkeydown="if(event.key==='Enter'){zoekAlles();}" autocomplete="off">
  <div class="action-row">
    <button id="searchBtn" type="button">Zoek voertuig</button>
    <button id="favoriteBtn" type="button">â˜† Favoriet toevoegen</button>
  </div>
  <ul id="suggestielijst"></ul>
  <div class="stack-card">
    <h3 id="favoritesTitle">Favorieten</h3>
    <div id="favoritesList" class="chip-row"></div>
  </div>
  <div class="stack-card">
    <h3 id="settingsTitle">Instellingen</h3>
    <div class="settings-grid">
      <div>
        <label for="intervalSelect" id="intervalLabel">Update-interval</label>
        <select id="intervalSelect">
          <option value="5000" id="intervalOpt5">5 seconden</option>
          <option value="10000" selected id="intervalOpt10">10 seconden</option>
          <option value="15000" id="intervalOpt15">15 seconden</option>
          <option value="30000" id="intervalOpt30">30 seconden</option>
        </select>
      </div>
      <div>
        <label for="themeSelect" id="themeLabel">Thema</label>
        <select id="themeSelect">
          <option value="auto" id="themeAutoOpt">Automatisch</option>
          <option value="light" id="themeLightOpt">Licht</option>
          <option value="dark" id="themeDarkOpt">Donker</option>
        </select>
      </div>
      <div>
        <label for="languageSelect" id="languageLabel">Taal</label>
        <select id="languageSelect">
          <option value="nl">Nederlands</option>
          <option value="fr">Francais</option>
          <option value="en">English</option>
          <option value="de">Deutsch</option>
          <option value="pl">Polski</option>
          <option value="es">Espanol</option>
          <option value="ru">Russkiy</option>
        </select>
      </div>
    </div>
  </div>

  <div class="grid" id="resultsGrid">
    <button class="close-btn" id="closeBtn" style="display:none; position: absolute; top: 2rem; right: 1.5rem; z-index: 100;" onclick="terug()" title="Venster sluiten" aria-label="Sluiten">&times;</button>
    <div class="card">
      <h2 id="staticCardTitle">Voertuiginformatie</h2>
      <div id="vasteData">Geen voertuig geselecteerd.</div>
    </div>

    <div class="card">
      <h2 id="realtimeCardTitle">Realtimegegevens</h2>
      <div class="meta-row">
        <button id="followToggle" type="button">Volgen: aan</button>
        <div id="lastUpdate">Laatste update: -</div>
      </div>
      <div id="realtime" class="loading">Geen gegevens beschikbaar.</div>
      <div id="map"></div>
    </div>
  </div>

  <footer style="margin-top: 4rem; padding: 2rem; border-top: 1px solid var(--border); color: var(--muted); font-size: 0.9rem;">
    <h3 id="disclaimerTitle">Disclaimer</h3>
    <p id="disclaimerText" style="margin-top: 0.5rem; line-height: 1.6;">De informatie op deze website wordt verstrekt zonder garanties. Busbibliotheek is niet aansprakelijk voor vertraging, fouten of onnauwkeurigheden in realtime gegevens. Gebruikers raadplegen deze informatie geheel op eigen risico. Raadpleeg voor officiele ritinformatie de bevoegde vervoersmaatschappij.</p>
  </footer>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Splash controls (mobile-first startup experience)
const splash = document.getElementById("splash");
function hideSplash(ms = 260) {
  const s = splash;
  if (!s || s.dataset.hiding === "1") return;
  s.dataset.hiding = "1";
  s.classList.add("hidden");
  const cleanup = () => {
    if (s.parentNode) s.parentNode.removeChild(s);
    document.querySelector('.grid')?.classList.add('show');
  };
  s.addEventListener("transitionend", cleanup, { once: true });
  setTimeout(cleanup, ms + 120);
}
window.addEventListener('load', () => setTimeout(hideSplash, 520));
splash?.addEventListener('click', () => hideSplash(150));
document.addEventListener('touchstart', () => hideSplash(150), { once: true });

// Install Prompt (beter gecontroleerde PWA-installatie)
let deferredPrompt = null;
const installBtn = document.getElementById('installBtn');
const iosInstallHintEl = document.getElementById("iosInstallHint");
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.classList.add('show');
});
installBtn.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`Gebruiker antwoord: ${outcome}`);
    deferredPrompt = null;
    installBtn.classList.remove('show');
  } else if (isIosInstallable()) {
    iosInstallHintEl.hidden = false;
  }
});
window.addEventListener('appinstalled', () => {
  console.log('App succesvol geinstalleerd');
  installBtn.classList.remove('show');
  iosInstallHintEl.hidden = true;
  deferredPrompt = null;
});

// Constants
const BASE_URL = "https://pub-611b5bc156eb455ba86d9bcece9aea1c.r2.dev";
const API_URL = "https://busbibliotheek95.pages.dev/api";
const FAVORITES_KEY = "bb_favorites_v1";
const SETTINGS_KEY = "bb_settings_v1";
let updateIntervalMs = 10000;

const voertuigInput = document.getElementById("voertuignummer");
const suggestieLijst = document.getElementById("suggestielijst");
const realtimeEl = document.getElementById("realtime");
const vasteDataEl = document.getElementById("vasteData");
const resultsGridEl = document.getElementById("resultsGrid");
const closeBtnEl = document.getElementById("closeBtn");
const mapEl = document.getElementById("map");
const searchBtn = document.getElementById("searchBtn");
const favoriteBtn = document.getElementById("favoriteBtn");
const favoritesListEl = document.getElementById("favoritesList");
const intervalSelect = document.getElementById("intervalSelect");
const themeSelect = document.getElementById("themeSelect");
const languageSelect = document.getElementById("languageSelect");
const intervalOpt5El = document.getElementById("intervalOpt5");
const intervalOpt10El = document.getElementById("intervalOpt10");
const intervalOpt15El = document.getElementById("intervalOpt15");
const intervalOpt30El = document.getElementById("intervalOpt30");
const themeAutoOptEl = document.getElementById("themeAutoOpt");
const themeLightOptEl = document.getElementById("themeLightOpt");
const themeDarkOptEl = document.getElementById("themeDarkOpt");
const followToggleBtn = document.getElementById("followToggle");
const lastUpdateEl = document.getElementById("lastUpdate");
const appTitleEl = document.getElementById("appTitle");
const appSubtitleEl = document.getElementById("appSubtitle");
const favoritesTitleEl = document.getElementById("favoritesTitle");
const settingsTitleEl = document.getElementById("settingsTitle");
const intervalLabelEl = document.getElementById("intervalLabel");
const themeLabelEl = document.getElementById("themeLabel");
const languageLabelEl = document.getElementById("languageLabel");
const staticCardTitleEl = document.getElementById("staticCardTitle");
const realtimeCardTitleEl = document.getElementById("realtimeCardTitle");
const disclaimerTitleEl = document.getElementById("disclaimerTitle");
const disclaimerTextEl = document.getElementById("disclaimerText");

let voertuigen = [];
let trips = [];
let routes = [];
let map, marker, refresh;
let trailLine = null;
let routeTrail = [];
let followVehicle = true;
let userInteracted = false;
let centerControl;
let delayMinutes = 0;
let currentVehicleId = "";
let favorites = [];
let settings = {
  intervalMs: 10000,
  theme: "auto",
  language: "nl"
};

const i18n = {
  nl: {
    subtitle: "Zoek een voertuig en volg het in realtime.",
    install: "Installeer app",
    iosHint: "Op iPhone/iPad: tik op Deel en kies 'Zet op beginscherm'.",
    search: "Zoek voertuig",
    favoriteAdd: "Favoriet toevoegen",
    favoriteRemove: "Favoriet verwijderen",
    favorites: "Favorieten",
    settings: "Instellingen",
    interval: "Update-interval",
    intervalSeconds: "seconden",
    theme: "Thema",
    themeAuto: "Automatisch",
    themeLight: "Licht",
    themeDark: "Donker",
    language: "Taal",
    staticCard: "Voertuiginformatie",
    realtimeCard: "Realtimegegevens",
    followOn: "Volgen: aan",
    followOff: "Volgen: uit",
    lastUpdate: "Laatste update",
    noData: "Geen realtimegegevens beschikbaar.",
    loading: "Gegevens laden...",
    noneSelected: "Geen voertuig geselecteerd.",
    noFixed: "Geen voertuiggegevens gevonden.",
    noFavoritesYet: "Nog geen favorieten.",
    vehiclePlaceholder: "Voertuignummer",
    notOutOfService: "Niet uit dienst",
    outOfServiceNoRealtime: "Realtime locatie niet beschikbaar: voertuig is uit dienst.",
    realtimeError: "Fout bij ophalen van realtimegegevens.",
    disclaimerTitle: "Disclaimer",
    disclaimerText: "De informatie op deze website wordt verstrekt zonder garanties. Busbibliotheek is niet aansprakelijk voor vertraging, fouten of onnauwkeurigheden in realtime gegevens. Gebruikers raadplegen deze informatie geheel op eigen risico. Raadpleeg voor officiele ritinformatie de bevoegde vervoersmaatschappij."
  },
  fr: {
    subtitle: "Recherchez un vehicule et suivez-le en temps reel.",
    install: "Installer l'app",
    iosHint: "Sur iPhone/iPad: touchez Partager puis 'Sur l'ecran d'accueil'.",
    search: "Rechercher vehicule",
    favoriteAdd: "Ajouter favori",
    favoriteRemove: "Retirer favori",
    favorites: "Favoris",
    settings: "Parametres",
    interval: "Intervalle de mise a jour",
    intervalSeconds: "secondes",
    theme: "Theme",
    themeAuto: "Automatique",
    themeLight: "Clair",
    themeDark: "Sombre",
    language: "Langue",
    staticCard: "Informations vehicule",
    realtimeCard: "Donnees temps reel",
    followOn: "Suivi: actif",
    followOff: "Suivi: inactif",
    lastUpdate: "Derniere mise a jour",
    noData: "Aucune donnee temps reel disponible.",
    loading: "Chargement des donnees...",
    noneSelected: "Aucun vehicule selectionne.",
    noFixed: "Aucune donnee vehicule trouvee.",
    noFavoritesYet: "Aucun favori pour l'instant.",
    vehiclePlaceholder: "Numero vehicule",
    notOutOfService: "Toujours en service",
    outOfServiceNoRealtime: "Position temps reel indisponible: vehicule hors service.",
    realtimeError: "Erreur lors de la recuperation des donnees temps reel.",
    disclaimerTitle: "Avertissement",
    disclaimerText: "Les informations de ce site sont fournies sans garantie. Busbibliotheek n'est pas responsable des retards, erreurs ou inexactitudes des donnees temps reel. Utilisation a vos propres risques. Pour des informations officielles, consultez l'operateur de transport."
  },
  en: {
    subtitle: "Search a vehicle and follow it in realtime.",
    install: "Install app",
    iosHint: "On iPhone/iPad: tap Share and choose 'Add to Home Screen'.",
    search: "Search vehicle",
    favoriteAdd: "Add favorite",
    favoriteRemove: "Remove favorite",
    favorites: "Favorites",
    settings: "Settings",
    interval: "Update interval",
    intervalSeconds: "seconds",
    theme: "Theme",
    themeAuto: "Automatic",
    themeLight: "Light",
    themeDark: "Dark",
    language: "Language",
    staticCard: "Vehicle information",
    realtimeCard: "Realtime data",
    followOn: "Follow: on",
    followOff: "Follow: off",
    lastUpdate: "Last update",
    noData: "No realtime data available.",
    loading: "Loading data...",
    noneSelected: "No vehicle selected.",
    noFixed: "No vehicle data found.",
    noFavoritesYet: "No favorites yet.",
    vehiclePlaceholder: "Vehicle number",
    notOutOfService: "Still in service",
    outOfServiceNoRealtime: "Realtime location unavailable: vehicle is out of service.",
    realtimeError: "Error while fetching realtime data.",
    disclaimerTitle: "Disclaimer",
    disclaimerText: "The information on this website is provided without guarantees. Busbibliotheek is not liable for delays, errors or inaccuracies in realtime data. Use at your own risk. For official trip information, consult the transport operator."
  },
  de: {
    subtitle: "Fahrzeug suchen und in Echtzeit verfolgen.",
    install: "App installieren",
    iosHint: "Auf iPhone/iPad: Teilen tippen und 'Zum Home-Bildschirm' waehlen.",
    search: "Fahrzeug suchen",
    favoriteAdd: "Favorit hinzufuegen",
    favoriteRemove: "Favorit entfernen",
    favorites: "Favoriten",
    settings: "Einstellungen",
    interval: "Aktualisierungsintervall",
    intervalSeconds: "Sekunden",
    theme: "Design",
    themeAuto: "Automatisch",
    themeLight: "Hell",
    themeDark: "Dunkel",
    language: "Sprache",
    staticCard: "Fahrzeuginformationen",
    realtimeCard: "Echtzeitdaten",
    followOn: "Folgen: an",
    followOff: "Folgen: aus",
    lastUpdate: "Letzte Aktualisierung",
    noData: "Keine Echtzeitdaten verfuegbar.",
    loading: "Daten werden geladen...",
    noneSelected: "Kein Fahrzeug ausgewaehlt.",
    noFixed: "Keine Fahrzeugdaten gefunden.",
    noFavoritesYet: "Noch keine Favoriten.",
    vehiclePlaceholder: "Fahrzeugnummer",
    notOutOfService: "Weiter im Dienst",
    outOfServiceNoRealtime: "Echtzeitposition nicht verfuegbar: Fahrzeug ausser Dienst.",
    realtimeError: "Fehler beim Laden der Echtzeitdaten.",
    disclaimerTitle: "Haftungsausschluss",
    disclaimerText: "Die Informationen auf dieser Website werden ohne Gewaehr bereitgestellt. Busbibliotheek haftet nicht fuer Verspaetungen, Fehler oder Ungenauigkeiten in Echtzeitdaten. Nutzung auf eigenes Risiko. Fuer offizielle Fahrtdaten den Verkehrsbetreiber konsultieren."
  },
  pl: {
    subtitle: "Wyszukaj pojazd i sledz go w czasie rzeczywistym.",
    install: "Zainstaluj aplikacje",
    iosHint: "Na iPhone/iPad: dotknij Udostepnij i wybierz 'Do ekranu poczatkowego'.",
    search: "Szukaj pojazdu",
    favoriteAdd: "Dodaj ulubiony",
    favoriteRemove: "Usun ulubiony",
    favorites: "Ulubione",
    settings: "Ustawienia",
    interval: "Interwal odswiezania",
    intervalSeconds: "sekund",
    theme: "Motyw",
    themeAuto: "Automatyczny",
    themeLight: "Jasny",
    themeDark: "Ciemny",
    language: "Jezyk",
    staticCard: "Informacje o pojezdzie",
    realtimeCard: "Dane na zywo",
    followOn: "Sledzenie: wl.",
    followOff: "Sledzenie: wyl.",
    lastUpdate: "Ostatnia aktualizacja",
    noData: "Brak danych czasu rzeczywistego.",
    loading: "Ladowanie danych...",
    noneSelected: "Nie wybrano pojazdu.",
    noFixed: "Nie znaleziono danych pojazdu.",
    noFavoritesYet: "Brak ulubionych.",
    vehiclePlaceholder: "Numer pojazdu",
    notOutOfService: "Wciaz w eksploatacji",
    outOfServiceNoRealtime: "Brak lokalizacji na zywo: pojazd wycofany z ruchu.",
    realtimeError: "Blad podczas pobierania danych na zywo.",
    disclaimerTitle: "Zastrzezenie",
    disclaimerText: "Informacje na tej stronie sa udostepniane bez gwarancji. Busbibliotheek nie odpowiada za opoznienia, bledy ani niedokladnosci danych na zywo. Korzystasz na wlasne ryzyko. W sprawie oficjalnych informacji skontaktuj sie z operatorem transportu."
  },
  es: {
    subtitle: "Busca un vehiculo y siguelo en tiempo real.",
    install: "Instalar app",
    iosHint: "En iPhone/iPad: toca Compartir y elige 'Anadir a pantalla de inicio'.",
    search: "Buscar vehiculo",
    favoriteAdd: "Agregar favorito",
    favoriteRemove: "Quitar favorito",
    favorites: "Favoritos",
    settings: "Configuracion",
    interval: "Intervalo de actualizacion",
    intervalSeconds: "segundos",
    theme: "Tema",
    themeAuto: "Automatico",
    themeLight: "Claro",
    themeDark: "Oscuro",
    language: "Idioma",
    staticCard: "Informacion del vehiculo",
    realtimeCard: "Datos en tiempo real",
    followOn: "Seguimiento: activo",
    followOff: "Seguimiento: inactivo",
    lastUpdate: "Ultima actualizacion",
    noData: "No hay datos en tiempo real.",
    loading: "Cargando datos...",
    noneSelected: "Ningun vehiculo seleccionado.",
    noFixed: "No se encontraron datos del vehiculo.",
    noFavoritesYet: "Aun no hay favoritos.",
    vehiclePlaceholder: "Numero de vehiculo",
    notOutOfService: "Sigue en servicio",
    outOfServiceNoRealtime: "Ubicacion en tiempo real no disponible: vehiculo fuera de servicio.",
    realtimeError: "Error al obtener datos en tiempo real.",
    disclaimerTitle: "Aviso legal",
    disclaimerText: "La informacion en este sitio se proporciona sin garantias. Busbibliotheek no es responsable por retrasos, errores o inexactitudes en datos en tiempo real. Uso bajo su propio riesgo. Para informacion oficial, consulte al operador de transporte."
  },
  ru: {
    subtitle: "Nayti transport i otslezhivat ego v realnom vremeni.",
    install: "Ustanovit prilozhenie",
    iosHint: "Na iPhone/iPad: nazhmite Podelitsya i vyberite 'Na ekran Domoy'.",
    search: "Nayti transport",
    favoriteAdd: "Dobavit v izbrannoe",
    favoriteRemove: "Udalit iz izbrannogo",
    favorites: "Izbrannoe",
    settings: "Nastroiki",
    interval: "Interval obnovleniya",
    intervalSeconds: "sekund",
    theme: "Tema",
    themeAuto: "Avto",
    themeLight: "Svetlaya",
    themeDark: "Temnaya",
    language: "Yazyk",
    staticCard: "Informatsiya o transporte",
    realtimeCard: "Dannie realtime",
    followOn: "Slezhenie: vkl",
    followOff: "Slezhenie: vykl",
    lastUpdate: "Poslednee obnovlenie",
    noData: "Dannye realtime nedostupny.",
    loading: "Zagruzka dannyh...",
    noneSelected: "Transport ne vybran.",
    noFixed: "Dannye o transporte ne naideni.",
    noFavoritesYet: "Izbrannyh poka net.",
    vehiclePlaceholder: "Nomer transporta",
    notOutOfService: "Vse esche v sluzhbe",
    outOfServiceNoRealtime: "Pozitsiya realtime nedostupna: transport vyveden iz sluzhby.",
    realtimeError: "Oshibka pri poluchenii dannyh realtime.",
    disclaimerTitle: "Otvetstvennost",
    disclaimerText: "Informatsiya na etom saite predostavlyaetsya bez garantii. Busbibliotheek ne neset otvetstvennosti za zaderzhki, oshibki ili netochnosti realtime dannyh. Ispolzovanie na vash risk. Za ofitsialnoi informatsiei obratites k perevozchiku."
  }
};

const t = (k) => i18n[settings.language]?.[k] || i18n.nl[k] || k;
const localWord = (key) => {
  const labels = {
    instagramSearch: { nl: "Zoek op Instagram", fr: "Chercher sur Instagram", en: "Search on Instagram", de: "Auf Instagram suchen", pl: "Szukaj na Instagramie", es: "Buscar en Instagram", ru: "Iskat v Instagram" },
    vehicle: { nl: "Voertuig", fr: "Vehicule", en: "Vehicle", de: "Fahrzeug", pl: "Pojazd", es: "Vehiculo", ru: "Transport" },
    line: { nl: "Lijn", fr: "Ligne", en: "Line", de: "Linie", pl: "Linia", es: "Linea", ru: "Marshrut" },
    destination: { nl: "Bestemming", fr: "Destination", en: "Destination", de: "Ziel", pl: "Kierunek", es: "Destino", ru: "Napravlenie" },
    delay: { nl: "Vertraging", fr: "Retard", en: "Delay", de: "Verspatung", pl: "Opoznienie", es: "Retraso", ru: "Zaderzhka" }
  };
  return labels[key]?.[settings.language] || labels[key]?.nl || key;
};

const vehicleFieldLabels = {
  nl: {
    "vervoersmaatschappij": "Vervoersmaatschappij",
    "voertuignummer": "Voertuignummer",
    "type": "Type",
    "hansea nummer": "Hansea nummer",
    "oude voertuignummers": "Oude voertuignummers",
    "oude nummerplaten": "Oude nummerplaten",
    "datum in dienst": "Datum in dienst",
    "uit dienst": "Uit dienst",
    "fabrikant": "Fabrikant",
    "model": "Model",
    "bouwjaar": "Bouwjaar",
    "nummerplaat": "Nummerplaat",
    "kenteken": "Kenteken",
    "status": "Status",
    "opmerkingen": "Opmerkingen"
  },
  fr: {
    "vervoersmaatschappij": "Compagnie de transport",
    "voertuignummer": "Numero du vehicule",
    "type": "Type",
    "hansea nummer": "Numero Hansea",
    "oude voertuignummers": "Anciens numeros de vehicule",
    "oude nummerplaten": "Anciennes plaques",
    "datum in dienst": "Date de mise en service",
    "uit dienst": "Hors service",
    "fabrikant": "Fabricant",
    "model": "Modele",
    "bouwjaar": "Annee de construction",
    "nummerplaat": "Plaque",
    "kenteken": "Immatriculation",
    "status": "Statut",
    "opmerkingen": "Remarques"
  },
  en: {
    "vervoersmaatschappij": "Operator",
    "voertuignummer": "Vehicle number",
    "type": "Type",
    "hansea nummer": "Hansea number",
    "oude voertuignummers": "Old vehicle numbers",
    "oude nummerplaten": "Old license plates",
    "datum in dienst": "In service date",
    "uit dienst": "Out of service",
    "fabrikant": "Manufacturer",
    "model": "Model",
    "bouwjaar": "Year built",
    "nummerplaat": "License plate",
    "kenteken": "Registration",
    "status": "Status",
    "opmerkingen": "Notes"
  },
  de: {
    "vervoersmaatschappij": "Verkehrsunternehmen",
    "voertuignummer": "Fahrzeugnummer",
    "type": "Typ",
    "hansea nummer": "Hansea-Nummer",
    "oude voertuignummers": "Alte Fahrzeugnummern",
    "oude nummerplaten": "Alte Kennzeichen",
    "datum in dienst": "Datum der Inbetriebnahme",
    "uit dienst": "Ausser Dienst",
    "fabrikant": "Hersteller",
    "model": "Modell",
    "bouwjaar": "Baujahr",
    "nummerplaat": "Kennzeichen",
    "kenteken": "Zulassung",
    "status": "Status",
    "opmerkingen": "Bemerkungen"
  },
  pl: {
    "vervoersmaatschappij": "Operator",
    "voertuignummer": "Numer pojazdu",
    "type": "Typ",
    "hansea nummer": "Numer Hansea",
    "oude voertuignummers": "Stare numery pojazdu",
    "oude nummerplaten": "Stare tablice",
    "datum in dienst": "Data rozpoczecia eksploatacji",
    "uit dienst": "Wycofany z ruchu",
    "fabrikant": "Producent",
    "model": "Model",
    "bouwjaar": "Rok produkcji",
    "nummerplaat": "Tablica rejestracyjna",
    "kenteken": "Rejestracja",
    "status": "Status",
    "opmerkingen": "Uwagi"
  },
  es: {
    "vervoersmaatschappij": "Operador",
    "voertuignummer": "Numero de vehiculo",
    "type": "Tipo",
    "hansea nummer": "Numero Hansea",
    "oude voertuignummers": "Numeros antiguos del vehiculo",
    "oude nummerplaten": "Matriculas antiguas",
    "datum in dienst": "Fecha de entrada en servicio",
    "uit dienst": "Fuera de servicio",
    "fabrikant": "Fabricante",
    "model": "Modelo",
    "bouwjaar": "Ano de fabricacion",
    "nummerplaat": "Matricula",
    "kenteken": "Registro",
    "status": "Estado",
    "opmerkingen": "Observaciones"
  },
  ru: {
    "vervoersmaatschappij": "Perevozchik",
    "voertuignummer": "Nomer transporta",
    "type": "Tip",
    "hansea nummer": "Nomer Hansea",
    "oude voertuignummers": "Starye nomera transporta",
    "oude nummerplaten": "Starye nomera znaka",
    "datum in dienst": "Data vvedeniya v ekspluatatsiyu",
    "uit dienst": "Vyveden iz sluzhby",
    "fabrikant": "Proizvoditel",
    "model": "Model",
    "bouwjaar": "God vypuska",
    "nummerplaat": "Gosnomer",
    "kenteken": "Registratsiya",
    "status": "Status",
    "opmerkingen": "Primechaniya"
  }
};

function normalizeFieldKey(key) {
  return (key || "")
    .toString()
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}

function translateVehicleFieldLabel(key) {
  const normalized = normalizeFieldKey(key);
  return (
    vehicleFieldLabels[settings.language]?.[normalized] ||
    vehicleFieldLabels.nl[normalized] ||
    key
  );
}

const localeForLanguage = (lang) => {
  const map = {
    nl: "nl-NL",
    fr: "fr-FR",
    en: "en-US",
    de: "de-DE",
    pl: "pl-PL",
    es: "es-ES",
    ru: "ru-RU"
  };
  return map[lang] || "nl-NL";
};

function isIosInstallable() {
  const ua = window.navigator.userAgent;
  const isIos = /iPhone|iPad|iPod/.test(ua);
  const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
  return isIos && !isStandalone;
}

function loadSettings() {
  try {
    const raw = localStorage.getItem(SETTINGS_KEY);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    settings = { ...settings, ...parsed };
  } catch (e) {
    console.warn("Settings laden mislukt", e);
  }
}

function saveSettings() {
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
}

function applyTheme(theme) {
  const root = document.documentElement;
  if (theme === "auto") root.removeAttribute("data-theme");
  else root.setAttribute("data-theme", theme);
}

function applyTranslations() {
  appSubtitleEl.textContent = t("subtitle");
  installBtn.textContent = t("install");
  iosInstallHintEl.textContent = t("iosHint");
  searchBtn.textContent = t("search");
  voertuigInput.placeholder = t("vehiclePlaceholder");
  favoritesTitleEl.textContent = t("favorites");
  settingsTitleEl.textContent = t("settings");
  intervalLabelEl.textContent = t("interval");
  themeLabelEl.textContent = t("theme");
  languageLabelEl.textContent = t("language");
  intervalOpt5El.textContent = `5 ${t("intervalSeconds")}`;
  intervalOpt10El.textContent = `10 ${t("intervalSeconds")}`;
  intervalOpt15El.textContent = `15 ${t("intervalSeconds")}`;
  intervalOpt30El.textContent = `30 ${t("intervalSeconds")}`;
  themeAutoOptEl.textContent = t("themeAuto");
  themeLightOptEl.textContent = t("themeLight");
  themeDarkOptEl.textContent = t("themeDark");
  staticCardTitleEl.textContent = t("staticCard");
  realtimeCardTitleEl.textContent = t("realtimeCard");
  disclaimerTitleEl.textContent = t("disclaimerTitle");
  disclaimerTextEl.textContent = t("disclaimerText");
  lastUpdateEl.textContent = `${t("lastUpdate")}: -`;
  if (!currentVehicleId) {
    realtimeEl.innerHTML = t("noData");
    vasteDataEl.innerHTML = t("noneSelected");
  }
  updateFavoriteButtonState();
  updateFollowButtonText();
}

function loadFavorites() {
  try {
    favorites = JSON.parse(localStorage.getItem(FAVORITES_KEY) || "[]");
    if (!Array.isArray(favorites)) favorites = [];
  } catch (e) {
    favorites = [];
  }
}

function saveFavorites() {
  localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
}

function renderFavorites() {
  favoritesListEl.innerHTML = "";
  if (!favorites.length) {
    const empty = document.createElement("span");
    empty.className = "loading";
    empty.textContent = t("noFavoritesYet");
    favoritesListEl.appendChild(empty);
    return;
  }
  favorites.forEach((id) => {
    const chip = document.createElement("button");
    chip.type = "button";
    chip.className = "chip";
    chip.textContent = id;
    chip.addEventListener("click", () => {
      voertuigInput.value = id;
      zoekAlles();
    });
    favoritesListEl.appendChild(chip);
  });
}

function updateFavoriteButtonState() {
  const id = voertuigInput.value.trim();
  const isFav = favorites.includes(id);
  favoriteBtn.textContent = isFav ? t("favoriteRemove") : t("favoriteAdd");
}

function toggleFavorite() {
  const id = voertuigInput.value.trim();
  if (!id) return;
  if (favorites.includes(id)) {
    favorites = favorites.filter((x) => x !== id);
  } else {
    favorites.unshift(id);
    favorites = [...new Set(favorites)].slice(0, 20);
  }
  saveFavorites();
  renderFavorites();
  updateFavoriteButtonState();
}

function restartRealtimeRefresh() {
  if (refresh) clearInterval(refresh);
  if (!currentVehicleId) return;
  refresh = setInterval(() => updateRealtime(currentVehicleId), updateIntervalMs);
}

function updateFollowButtonText() {
  followToggleBtn.textContent = followVehicle ? t("followOn") : t("followOff");
}

function initAppPreferences() {
  loadSettings();
  if (!i18n[settings.language]) settings.language = "nl";
  loadFavorites();
  updateIntervalMs = Number(settings.intervalMs) || 10000;
  intervalSelect.value = String(updateIntervalMs);
  themeSelect.value = settings.theme;
  languageSelect.value = settings.language;
  applyTheme(settings.theme);
  applyTranslations();
  renderFavorites();
  updateFavoriteButtonState();

  if (isIosInstallable()) {
    iosInstallHintEl.hidden = false;
  }
}

searchBtn.addEventListener("click", zoekAlles);
favoriteBtn.addEventListener("click", toggleFavorite);
voertuigInput.addEventListener("input", updateFavoriteButtonState);
followToggleBtn.addEventListener("click", () => {
  followVehicle = !followVehicle;
  if (followVehicle) userInteracted = false;
  updateFollowButtonText();
});
intervalSelect.addEventListener("change", () => {
  settings.intervalMs = Number(intervalSelect.value);
  updateIntervalMs = settings.intervalMs;
  saveSettings();
  restartRealtimeRefresh();
});
themeSelect.addEventListener("change", () => {
  settings.theme = themeSelect.value;
  saveSettings();
  applyTheme(settings.theme);
});
languageSelect.addEventListener("change", () => {
  settings.language = languageSelect.value;
  saveSettings();
  applyTranslations();
  renderFavorites();
});

// Helper: CSV parser that respects quoted fields
function parseCSVLine(line){
  const fields = [];
  let cur = "";
  let inQuotes = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"') { cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if(ch === ',' && !inQuotes){
      fields.push(cur);
      cur = "";
    } else { cur += ch; }
  }
  fields.push(cur);
  return fields.map(f => f.trim().replace(/^"|"$/g, ''));
}

// Helper: normalize ids/strings for matching
const normalize = s => (s||"").toString().replace(/"/g, "").trim();

// Custom bus pin as DivIcon so we can rotate the image based on bearing
const busIcon = L.divIcon({
  className: 'bus-div-icon',
  html: `<img src="navicon.png" style="width:36px;height:36px;transform:rotate(0deg);display:block;transform-origin:18px 28px;transition: transform 0.25s linear;"/>`,
  iconSize: [36,36],
  iconAnchor: [18,36]
});

async function laadVoertuigen() {
  const res = await fetch(`${BASE_URL}/vehicles.txt`, { cache: "no-store" });
  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = regels[0].split(";");

  voertuigen = regels.slice(1).map(r => {
    const v = r.split(";");
    const obj = {};
    headers.forEach((h,i)=>obj[h.trim()] = v[i]?.trim() || "/");
    return obj;
  });
}

async function laadTrips() {
  const res = await fetch(`${BASE_URL}/trips.txt`, { cache: "no-store" });
  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = parseCSVLine(regels[0]).map(h => h.trim());

  trips = regels.slice(1).map(r => {
    const values = parseCSVLine(r);
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i] || "/");
    return obj;
  });
}

async function laadRoutes() {
  const res = await fetch(`${BASE_URL}/routes.txt`, { cache: "no-store" });
  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = parseCSVLine(regels[0]).map(h => h.trim());

  routes = regels.slice(1).map(r => {
    const values = parseCSVLine(r);
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i] || "/");
    return obj;
  });
}

initAppPreferences();
laadVoertuigen();
laadTrips();
laadRoutes();

function toonSuggesties() {
  const q = voertuigInput.value.toLowerCase();
  suggestieLijst.innerHTML = "";
  if(!q) return;

  voertuigen.filter(v => v.Voertuignummer?.toLowerCase().startsWith(q))
    .slice(0,8)
    .forEach(v=>{
      const li=document.createElement("li");
      li.textContent = `${v.Voertuignummer} - ${v.Type}`;
      li.onclick=()=>{
        voertuigInput.value=v.Voertuignummer;
        suggestieLijst.innerHTML="";
        voertuigInput.blur(); // Focus weghalen zodat geen enter meer nodig is
        zoekAlles();
      };
      suggestieLijst.appendChild(li);
    });
}

async function zoekAlles() {
  const id = voertuigInput.value.trim();
  if(!id) return;
  currentVehicleId = id;
  followVehicle = true;
  userInteracted = false;
  updateFollowButtonText();
  updateFavoriteButtonState();

  suggestieLijst.innerHTML = "";
  resultsGridEl.classList.add("show");
  closeBtnEl.style.display = "block";

  toonVasteData(id);

  if (voertuigen.length === 0) await laadVoertuigen();
  const bus = findBusById(id);
  if (isOutOfService(bus)) {
    realtimeEl.innerHTML = t("outOfServiceNoRealtime");
    mapEl.classList.add("hidden");
    routeTrail = [];
    if (trailLine && map) {
      map.removeLayer(trailLine);
      trailLine = null;
    }
    if (marker && map) {
      map.removeLayer(marker);
      marker = null;
    }
    lastUpdateEl.textContent = `${t("lastUpdate")}: -`;
    if(refresh) {
      clearInterval(refresh);
      refresh = null;
    }
    return;
  }

  realtimeEl.innerHTML = `<span class='spinner'></span><span class='loading'>${t("loading")}</span>`;
  routeTrail = [];
  if (trailLine && map) {
    map.removeLayer(trailLine);
    trailLine = null;
  }

  updateRealtime(id);
  if(refresh) clearInterval(refresh);
  refresh = setInterval(()=>updateRealtime(id), updateIntervalMs);
}

function terug() {
  resultsGridEl.classList.remove("show");
  closeBtnEl.style.display = "none";
  realtimeEl.innerHTML = t("noData");
  vasteDataEl.innerHTML = t("noneSelected");
  voertuigInput.value = "";
  currentVehicleId = "";
  routeTrail = [];
  if(refresh) {
    clearInterval(refresh);
    refresh = null;
  }
  if (trailLine && map) {
    map.removeLayer(trailLine);
    trailLine = null;
  }
  lastUpdateEl.textContent = `${t("lastUpdate")}: -`;
  if(marker){ map.removeLayer(marker); marker=null; }
  updateFavoriteButtonState();
}

function findBusById(id) {
  return voertuigen.find(v =>
    v.Voertuignummer === id ||
    v["Hansea nummer"] === id ||
    v["Oude voertuignummers"]?.split(/[, ]+/).includes(id) ||
    v["Oude nummerplaten"]?.split(/[, ]+/).includes(id)
  );
}

function isOutOfService(bus) {
  if (!bus) return false;
  const outKeys = Object.keys(bus).filter(k => k.toLowerCase().includes("uit dienst"));
  for (const k of outKeys) {
    const val = (bus[k] || "").toString().trim();
    if (val && val !== "/") return true;
  }
  return false;
}

function toonVasteData(id){
  const bus = findBusById(id);

  if(!bus){
    vasteDataEl.innerHTML=t("noFixed");
    return;
  }

  let html=`<p class="voertuignummer-display">${bus.Voertuignummer}</p>`;
  if(bus.Type) html += `<p style="font-size:1.1rem;font-weight:700;color:var(--text);margin-bottom:0.8rem;">${bus.Type}</p>`;
  html+="<table>";
  for(const [k,v] of Object.entries(bus)){
    if(k==="Vervoersmaatschappij"||k==="Voertuignummer"||k==="Type") continue;

    let waarde = v;
    const key = k.toLowerCase();

    if(key.includes("datum in dienst") && v!=="/") {
      waarde = new Date(v).toLocaleDateString(localeForLanguage(settings.language),{year:'numeric',month:'long',day:'numeric'});
    } else if(key.includes("uit dienst")) {
      if(v==="/") waarde = t("notOutOfService");
      else waarde = new Date(v).toLocaleDateString(localeForLanguage(settings.language),{year:'numeric',month:'long',day:'numeric'});
    } else if(key.includes("datum") && v!=="/") {
      waarde = new Date(v).toLocaleDateString(localeForLanguage(settings.language),{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    } else {
      if(v==="/") continue;
    }
    html+=`<tr><th>${translateVehicleFieldLabel(k)}</th><td>${waarde}</td></tr>`;
  }
  html+="</table>";
  const igUrl = 'https://www.instagram.com/explore/search/keyword/?q=' + encodeURIComponent('#dl' + id);
  html += `<p class="ig-btn-wrap"><a class="btn btn--instagram" href="${igUrl}" target="_blank" rel="noopener">${localWord("instagramSearch")}</a></p>`;
  vasteDataEl.innerHTML=html;
}

function initMap(lat,lon){
  if(!map){
    map=L.map("map").setView([lat,lon],14);

    // Cleaner base map suitable for transit (CartoDB Positron)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors &amp; <a href="https://carto.com/">CARTO</a>'
    }).addTo(map);

    // Optional transport overlay (rail/lines) - may enhance transit visualization
    const transportOverlay = L.tileLayer('https://a.tile.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenRailwayMap'
    });
    transportOverlay.addTo(map);

    // Detect user interactions to stop auto-centering
    map.on('dragstart zoomstart movestart touchstart', ()=>{
      userInteracted = true;
      followVehicle = false;
      updateFollowButtonText();
      if(centerControl) centerControl.getContainer().style.display = 'block';
    });

    // Create a custom control (button) to re-center the map
    const CenterControl = L.Control.extend({
      onAdd: function(map){
        const el = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const btn = L.DomUtil.create('a', 'map-center-btn', el);
        btn.innerHTML = 'C';
        btn.title = 'Centreren';
        btn.href = '#';
        btn.style.display = 'none';
        btn.style.width = '30px';
        btn.style.height = '30px';
        btn.style.lineHeight = '30px';
        btn.style.textAlign = 'center';

        L.DomEvent.on(btn, 'click', L.DomEvent.stopPropagation)
                 .on(btn, 'click', L.DomEvent.preventDefault)
                 .on(btn, 'click', ()=>{
                   if(marker){
                     map.setView(marker.getLatLng(), Math.max(map.getZoom(), 15));
                     userInteracted = false;
                     followVehicle = true;
                     updateFollowButtonText();
                     btn.style.display = 'none';
                   }
                 });

        return el;
      }
    });

    centerControl = new CenterControl({ position: 'topright' });
    centerControl.addTo(map);
  }
}

async function updateRealtime(id){
  try{
    const res = await fetch(API_URL);
    const data = await res.json();

    const gps = data.entity.reverse().find(e=>e.vehicle?.vehicle?.id==id && e.vehicle.position);

    if(!gps){ realtimeEl.innerHTML=t("noData"); mapEl.classList.add("hidden"); return; }

    const v=gps.vehicle;
    const tripid = gps.vehicle.trip?.tripId || gps.vehicle.trip?.trip_id || "";

    // Zorg dat trips/routes geladen zijn
    if(trips.length===0) await laadTrips();
    if(routes.length===0) await laadRoutes();

    // Robuuste matching: normaliseer en probeer exact / endsWith / includes
    const nTripId = normalize(tripid);
    let tripData = trips.find(t => normalize(t.trip_id) === nTripId);
    if(!tripData && nTripId){
      tripData = trips.find(t => {
        const tId = normalize(t.trip_id);
        return tId && (
          tId === nTripId ||
          tId.endsWith(nTripId) ||
          nTripId.endsWith(tId) ||
          tId.includes(nTripId) ||
          nTripId.includes(tId)
        );
      });
    }
    

    const routeId = tripData?.route_id || "";
    let routeData = routes.find(r => r.route_id === routeId);
    if(!routeData && routeId){
      routeData = routes.find(r => r.route_id && (
        r.route_id === routeId ||
        r.route_id.includes(routeId) ||
        routeId.includes(r.route_id)
      ));
    }

    const routeShort = routeData?.route_short_name || "?";
    const routeLong = routeData?.route_long_name || "";
    const tripShort = tripData ? (tripData.trip_headsign || tripData.trip_short_name || "") : "";
    const routeColorRaw = (routeData?.route_color || "").replace(/[^0-9a-fA-F]/g, "").slice(0, 6);
    const routeTextColorRaw = (routeData?.route_text_color || "").replace(/[^0-9a-fA-F]/g, "").slice(0, 6);
    const routeColor = routeColorRaw.length === 6 ? `#${routeColorRaw}` : "#2563eb";
    const routeTextColor = routeTextColorRaw.length === 6 ? `#${routeTextColorRaw}` : "#ffffff";

    // Extract delay in seconds and convert to minutes
    let delaySeconds = gps.vehicle.trip?.delay || 0;
    if (!delaySeconds && v.stopStatus?.delay) delaySeconds = v.stopStatus.delay;
    delayMinutes = Math.round(delaySeconds / 60);
    
    let msgDelay = "";
    if (delayMinutes < 0) {
      const mins = Math.abs(delayMinutes);
      if (settings.language === "en") msgDelay = `${mins} min early`;
      else if (settings.language === "fr") msgDelay = `${mins} min d'avance`;
      else if (settings.language === "de") msgDelay = `${mins} Min zu fruh`;
      else if (settings.language === "pl") msgDelay = `${mins} min za wczesnie`;
      else if (settings.language === "es") msgDelay = `${mins} min antes`;
      else if (settings.language === "ru") msgDelay = `${mins} min ranshe`;
      else msgDelay = `${mins} minuut${mins !== 1 ? "en" : ""} te vroeg`;
    } else if (delayMinutes > 0) {
      if (settings.language === "en") msgDelay = `${delayMinutes} min delay`;
      else if (settings.language === "fr") msgDelay = `${delayMinutes} min de retard`;
      else if (settings.language === "de") msgDelay = `${delayMinutes} Min Verspatung`;
      else if (settings.language === "pl") msgDelay = `${delayMinutes} min opoznienia`;
      else if (settings.language === "es") msgDelay = `${delayMinutes} min de retraso`;
      else if (settings.language === "ru") msgDelay = `${delayMinutes} min zaderzhki`;
      else msgDelay = `${delayMinutes} minuut${delayMinutes !== 1 ? "en" : ""} vertraging`;
    } else {
      if (settings.language === "en") msgDelay = "On time";
      else if (settings.language === "fr") msgDelay = "A l'heure";
      else if (settings.language === "de") msgDelay = "Punktlich";
      else if (settings.language === "pl") msgDelay = "Na czas";
      else if (settings.language === "es") msgDelay = "A tiempo";
      else if (settings.language === "ru") msgDelay = "Vovremya";
      else msgDelay = "Op tijd";
    }
    const delayClass = delayMinutes < 0 ? "delay-early" : delayMinutes > 0 ? "delay-late" : "delay-ontime";

    realtimeEl.innerHTML=`
      <p>
        <div class="route-destination-row">
          <span class="line-badge" style="background:${routeColor};color:${routeTextColor};">${routeShort}</span>
          <span class="destination-text">${tripShort || "-"}</span>
        </div>
        <span class="delay-status ${delayClass}">${msgDelay}</span>
      </p>
    `;
    mapEl.classList.remove("hidden");
    lastUpdateEl.textContent = `${t("lastUpdate")}: ${new Date().toLocaleTimeString(localeForLanguage(settings.language))}`;

    initMap(v.position.latitude,v.position.longitude);
    routeTrail.push([v.position.latitude, v.position.longitude]);
    if (routeTrail.length > 35) routeTrail.shift();
    if (routeTrail.length >= 2) {
      if (!trailLine) {
        trailLine = L.polyline(routeTrail, { color: "#ef4444", weight: 4, opacity: 0.75 }).addTo(map);
      } else {
        trailLine.setLatLngs(routeTrail);
      }
    }

    if (followVehicle) {
      map.setView([v.position.latitude,v.position.longitude],15);
    }

    const bearing = v.position.bearing || 0;

    if(marker) {
      marker.setLatLng([v.position.latitude,v.position.longitude]);
      marker.setPopupContent(`${localWord("vehicle")} ${id}<br>${localWord("line")} ${routeShort}<br>${localWord("destination")}: ${tripShort}<br>${localWord("delay")}: ${msgDelay}`);
      // update rotation of img inside divIcon
      const el = marker.getElement && marker.getElement();
      if(el){
        const img = el.querySelector('img');
        if(img) img.style.transform = `rotate(${bearing}deg)`;
      }
    } else {
      marker = L.marker([v.position.latitude,v.position.longitude], { icon: busIcon })
        .addTo(map)
        .bindPopup(`${localWord("vehicle")} ${id}<br>${localWord("line")} ${routeShort}<br>${localWord("destination")}: ${tripShort}<br>${localWord("delay")}: ${msgDelay}`)
        .openPopup();
      // set initial rotation
      const el = marker.getElement && marker.getElement();
      if(el){
        const img = el.querySelector('img');
        if(img) img.style.transform = `rotate(${bearing}deg)`;
      }
    }

  }catch(e){ console.error(e); realtimeEl.innerHTML = t("realtimeError"); }
}
</script>

<!-- Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .catch(err => console.error('Service Worker registratie mislukt:', err));
}
</script>
</body>
</html>



