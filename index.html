<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Busbibliotheek Live</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">

<style>
  body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
  .container { max-width: 800px; margin: 2rem auto; padding: 1rem; }
  input { width: 100%; padding: 1rem; font-size: 1.2rem; margin-bottom: .5rem; }
  ul { list-style: none; padding: 0; margin: 0 0 1rem 0; border: 1px solid #ccc; border-radius: 6px; }
  li { padding: .5rem 1rem; cursor: pointer; }
  li:hover { background: #eee; }
  .grid { display: flex; gap: 1rem; margin-top: 1rem; opacity: 0; transform: translateY(20px); transition: 0.5s; }
  .grid.show { opacity: 1; transform: translateY(0); }
  .card { flex: 1; background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  #map { height: 300px; margin-top: .5rem; }
  table { width: 100%; border-collapse: collapse; }
  th, td { text-align: left; padding: .3rem .5rem; }
  th { font-weight: 600; }
  .back-btn { margin-top: 1rem; padding: .5rem 1rem; cursor: pointer; background: #eee; border: none; border-radius: 6px; }
  .back-btn:hover { background: #ddd; }
  .voertuignummer-display { font-size: 1.5rem; font-weight: 700; }
</style>
</head>

<body>
<div class="container">

  <h1>üöå Busbibliotheek Live</h1>
  <p>Zoek een voertuig en volg ‚Äòm live.</p>

  <input id="voertuignummer" placeholder="Voertuignummer" oninput="toonSuggesties()" onkeydown="if(event.key==='Enter'){zoekAlles();}">
  <ul id="suggestielijst"></ul>

  <div class="grid" id="resultsGrid">
    <div class="card">
      <h2>üìã Voertuiginfo</h2>
      <div id="vasteData">Nog geen voertuig geselecteerd.</div>
    </div>

    <div class="card">
      <h2>üìç Realtime</h2>
      <div id="realtime">Nog geen data.</div>
      <div id="map"></div>
    </div>
  </div>

  <button id="backBtn" class="back-btn" style="display:none;" onclick="terug()">‚¨Ö Terug</button>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let voertuigen = [];
let map, marker, refresh;

/* ===============================
   LAAD VOERTUIGEN
================================ */
async function laadVoertuigen() {
  const res = await fetch(
    "https://pub-611b5bc156eb455ba86d9bcece9aea1c.r2.dev/vehicles.txt",
    { cache: "no-store" }
  );

  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = regels[0].split(";");

  voertuigen = regels.slice(1).map(r => {
    const v = r.split(";");
    const obj = {};
    headers.forEach((h, i) => obj[h.trim()] = v[i]?.trim() || "/");
    return obj;
  });

  console.log("‚úÖ voertuigen geladen:", voertuigen.length);
}
laadVoertuigen();

/* ===============================
   SUGGESTIES
================================ */
function toonSuggesties() {
  const q = voertuignummer.value.toLowerCase();
  suggestielijst.innerHTML = "";
  if (!q) return;

  voertuigen
    .filter(v => v.Voertuignummer?.toLowerCase().startsWith(q))
    .slice(0, 8)
    .forEach(v => {
      const li = document.createElement("li");
      li.textContent = `${v.Voertuignummer} ‚Äì ${v.Type}`;
      li.onclick = () => {
        voertuignummer.value = v.Voertuignummer;
        suggestielijst.innerHTML = "";
        zoekAlles();
      };
      suggestielijst.appendChild(li);
    });
}

/* ===============================
   ZOEK ALLES
================================ */
function zoekAlles() {
  const id = voertuignummer.value.trim();
  if (!id) return;

  document.getElementById("resultsGrid").classList.add("show");
  document.getElementById("backBtn").style.display = "inline-block";

  toonVasteData(id);
  updateRealtime(id);

  if (refresh) clearInterval(refresh);
  refresh = setInterval(() => updateRealtime(id), 10000);
}

/* ===============================
   TERUG
================================ */
function terug() {
  document.getElementById("resultsGrid").classList.remove("show");
  document.getElementById("backBtn").style.display = "none";
  realtime.innerHTML = "Nog geen data.";
  vasteData.innerHTML = "Nog geen voertuig geselecteerd.";
  voertuignummer.value = "";
  if (marker) { map.removeLayer(marker); marker = null; }
}

/* ===============================
   VASTE DATA
================================ */
function toonVasteData(id) {
  const bus = voertuigen.find(v =>
    v.Voertuignummer === id ||
    v["Hansea nummer"] === id ||
    v["Oude voertuignummers"]?.split(/[, ]+/).includes(id) ||
    v["Oude nummerplaten"]?.split(/[, ]+/).includes(id)
  );

  if (!bus) {
    vasteData.innerHTML = "‚ùå Geen voertuigdata gevonden.";
    return;
  }

  let html = `<p class="voertuignummer-display">${bus.Voertuignummer}</p><table>`;
  for (const [k, v] of Object.entries(bus)) {
    if (k === "Vervoersmaatschappij") continue;

    let waarde = v;
    if (k.toLowerCase().includes("datum") && v !== "/") {
      waarde = new Date(v).toLocaleDateString("nl-NL", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    } else if (v === "/") {
      waarde = k.toLowerCase().includes("uit dienst") ? "Niet uit dienst" : "Niet afgeschreven";
    }

    html += `<tr><th>${k}</th><td>${waarde}</td></tr>`;
  }
  html += "</table>";
  vasteData.innerHTML = html;
}

/* ===============================
   MAP
================================ */
function initMap(lat, lon) {
  map = L.map("map").setView([lat, lon], 14);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(map);
}

/* ===============================
   REALTIME
================================ */
async function updateRealtime(id) {
  try {
    const res = await fetch("https://busbibliotheek95.pages.dev/api");
    const data = await res.json();

    const gps = data.entity
      .reverse()
      .find(e => e.vehicle?.vehicle?.id == id && e.vehicle.position);

    if (!gps) {
      realtime.innerHTML = "‚ùå Geen realtime data.";
      return;
    }

    const v = gps.vehicle;

    realtime.innerHTML = `
      <p>
        <b>Latitude:</b> ${v.position.latitude}<br>
        <b>Longitude:</b> ${v.position.longitude}<br>
        <b>Richting:</b> ${v.position.bearing}¬∞
      </p>
    `;

    if (!map) initMap(v.position.latitude, v.position.longitude);
    map.setView([v.position.latitude, v.position.longitude], 15);

    if (marker)
      marker.setLatLng([v.position.latitude, v.position.longitude]);
    else
      marker = L.marker([v.position.latitude, v.position.longitude])
        .addTo(map)
        .bindPopup(`Voertuig ${id}`)
        .openPopup();

  } catch (e) {
    console.error(e);
    realtime.innerHTML = "‚ö†Ô∏è Fout bij realtime data.";
  }
}
</script>
</body>
</html>