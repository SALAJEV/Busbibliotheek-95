<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Zoek een voertuig en volg 'm live.">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Busbibliotheek">
<link rel="apple-touch-icon" href="logo_light.png">
<link rel="manifest" href="manifest.json">
<title>Busbibliotheek</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<link rel="stylesheet" href="style.css?v=20260214-3">
</head>
<body>
<div id="splash" role="img" aria-label="Busbibliotheek laden">
  <picture class="logo">
    <source media="(prefers-color-scheme: light)" srcset="logo_light.png">
    <source media="(prefers-color-scheme: dark)" srcset="logo_dark.png">
    <img src="logo_light.png" alt="Busbibliotheek">
  </picture>
</div>
<div class="container">
  <div class="header-bar">
    <div>
      <h1 id="appTitle">Busbibliotheek</h1>
      <p id="appSubtitle">Zoekt een voertuig op en volg het in realtime.</p>
    </div>
    <div class="header-actions">
      <button id="installBtn" title="App installeren op thuisscherm">Installeer App</button>
      <button id="settingsToggleBtn" class="icon-btn" type="button" title="Instellingen" aria-label="Instellingen" aria-controls="settingsPanel" aria-expanded="false">⚙</button>
    </div>
  </div>
  <div id="iosInstallHint" class="hint" hidden></div>

  <input id="voertuignummer" placeholder="Voertuignummer" 
         oninput="toonSuggesties()" 
         onkeydown="if(event.key==='Enter'){zoekAlles();}" autocomplete="off">
  <div class="action-row">
    <button id="searchBtn" type="button">Zoek voertuig</button>
    <button id="favoriteBtn" type="button">☆ Favoriet toevoegen</button>
  </div>
  <ul id="suggestielijst"></ul>
  <div class="stack-card">
    <h3 id="favoritesTitle">Favorieten</h3>
    <div id="favoritesList" class="chip-row"></div>
  </div>

  <div class="results-wrap">
    <button class="close-btn" id="closeBtn" onclick="terug()" title="Venster sluiten" aria-label="Sluiten">&times;</button>
    <div class="grid" id="resultsGrid">
      <div class="card">
        <h2 id="staticCardTitle">Voertuiginformatie</h2>
        <div id="vasteData">Geen voertuig geselecteerd.</div>
      </div>

      <div class="card">
        <h2 id="realtimeCardTitle">Realtimegegevens</h2>
        <div class="meta-row">
          <button id="followToggle" type="button">Volgen: aan</button>
          <div id="lastUpdate">Laatste update: -</div>
        </div>
        <div id="realtime" class="loading">Geen gegevens beschikbaar.</div>
        <div id="map"></div>
      </div>
    </div>
  </div>

  <footer>
    <h3 id="disclaimerTitle">Disclaimer</h3>
    <p id="disclaimerText">De informatie op deze website wordt verstrekt zonder garanties. Busbibliotheek is niet aansprakelijk voor vertraging, fouten of onnauwkeurigheden in realtime gegevens. Gebruikers raadplegen deze informatie geheel op eigen risico. Raadpleeg voor officiele ritinformatie de bevoegde vervoersmaatschappij.</p>
  </footer>

</div>

<div id="settingsBackdrop" class="settings-backdrop"></div>
<aside id="settingsPanel" class="settings-panel" aria-hidden="true" inert>
  <div class="settings-panel-header">
    <h3 id="settingsTitle">Instellingen</h3>
    <button id="settingsCloseBtn" class="settings-close-btn" type="button" title="Sluit instellingen" aria-label="Sluit instellingen">&times;</button>
  </div>
  <div class="settings-grid">
    <div>
      <label for="intervalSelect" id="intervalLabel">Update-interval</label>
      <select id="intervalSelect">
        <option value="5000" id="intervalOpt5">5 seconden</option>
        <option value="10000" selected id="intervalOpt10">10 seconden</option>
        <option value="15000" id="intervalOpt15">15 seconden</option>
        <option value="30000" id="intervalOpt30">30 seconden</option>
      </select>
    </div>
    <div>
      <label for="themeSelect" id="themeLabel">Thema</label>
      <select id="themeSelect">
        <option value="auto" id="themeAutoOpt">Automatisch</option>
        <option value="light" id="themeLightOpt">Licht</option>
        <option value="dark" id="themeDarkOpt">Donker</option>
      </select>
    </div>
    <div>
      <label for="languageSelect" id="languageLabel">Taal</label>
      <select id="languageSelect">
        <option value="nl">Nederlands</option>
        <option value="fr">Francais</option>
        <option value="en">English</option>
        <option value="de">Deutsch</option>
        <option value="pl">Polski</option>
        <option value="es">Espanol</option>
        <option value="ru">Russkiy</option>
      </select>
    </div>
  </div>
</aside>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="translations.js"></script>
<script>
// Splash controls (mobile-first startup experience)
const splash = document.getElementById("splash");
function hideSplash(ms = 260) {
  const s = splash;
  if (!s || s.dataset.hiding === "1") return;
  s.dataset.hiding = "1";
  s.classList.add("hidden");
  const cleanup = () => {
    if (s.parentNode) s.parentNode.removeChild(s);
    document.querySelector('.grid')?.classList.add('show');
  };
  s.addEventListener("transitionend", cleanup, { once: true });
  setTimeout(cleanup, ms + 120);
}
window.addEventListener('load', () => setTimeout(hideSplash, 520));
splash?.addEventListener('click', () => hideSplash(150));
document.addEventListener('touchstart', () => hideSplash(150), { once: true });

// Install Prompt (beter gecontroleerde PWA-installatie)
let deferredPrompt = null;
const installBtn = document.getElementById('installBtn');
const iosInstallHintEl = document.getElementById("iosInstallHint");
const settingsPanelEl = document.getElementById("settingsPanel");
const settingsBackdropEl = document.getElementById("settingsBackdrop");
const settingsToggleBtn = document.getElementById("settingsToggleBtn");
const settingsCloseBtn = document.getElementById("settingsCloseBtn");
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.classList.add('show');
});
installBtn.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`Gebruiker antwoord: ${outcome}`);
    deferredPrompt = null;
    installBtn.classList.remove('show');
  } else if (isIosInstallable()) {
    iosInstallHintEl.hidden = false;
  }
});
window.addEventListener('appinstalled', () => {
  console.log('App succesvol geinstalleerd');
  installBtn.classList.remove('show');
  iosInstallHintEl.hidden = true;
  deferredPrompt = null;
});

// Constants
const BASE_URL = "https://pub-611b5bc156eb455ba86d9bcece9aea1c.r2.dev";
const API_URL = "https://busbibliotheek95.pages.dev/api";
const FAVORITES_KEY = "bb_favorites_v1";
const SETTINGS_KEY = "bb_settings_v1";
let updateIntervalMs = 10000;

const voertuigInput = document.getElementById("voertuignummer");
const suggestieLijst = document.getElementById("suggestielijst");
const realtimeEl = document.getElementById("realtime");
const vasteDataEl = document.getElementById("vasteData");
const resultsGridEl = document.getElementById("resultsGrid");
const closeBtnEl = document.getElementById("closeBtn");
const mapEl = document.getElementById("map");
const searchBtn = document.getElementById("searchBtn");
const favoriteBtn = document.getElementById("favoriteBtn");
const favoritesListEl = document.getElementById("favoritesList");
const intervalSelect = document.getElementById("intervalSelect");
const themeSelect = document.getElementById("themeSelect");
const languageSelect = document.getElementById("languageSelect");
const intervalOpt5El = document.getElementById("intervalOpt5");
const intervalOpt10El = document.getElementById("intervalOpt10");
const intervalOpt15El = document.getElementById("intervalOpt15");
const intervalOpt30El = document.getElementById("intervalOpt30");
const themeAutoOptEl = document.getElementById("themeAutoOpt");
const themeLightOptEl = document.getElementById("themeLightOpt");
const themeDarkOptEl = document.getElementById("themeDarkOpt");
const followToggleBtn = document.getElementById("followToggle");
const lastUpdateEl = document.getElementById("lastUpdate");
const appTitleEl = document.getElementById("appTitle");
const appSubtitleEl = document.getElementById("appSubtitle");
const favoritesTitleEl = document.getElementById("favoritesTitle");
const settingsTitleEl = document.getElementById("settingsTitle");
const intervalLabelEl = document.getElementById("intervalLabel");
const themeLabelEl = document.getElementById("themeLabel");
const languageLabelEl = document.getElementById("languageLabel");
const staticCardTitleEl = document.getElementById("staticCardTitle");
const realtimeCardTitleEl = document.getElementById("realtimeCardTitle");
const disclaimerTitleEl = document.getElementById("disclaimerTitle");
const disclaimerTextEl = document.getElementById("disclaimerText");

let voertuigen = [];
let trips = [];
let routes = [];
let map, marker, refresh;
let trailLine = null;
let routeTrail = [];
let followVehicle = true;
let userInteracted = false;
let centerControl;
let delayMinutes = 0;
let currentVehicleId = "";
let favorites = [];
let settingsOpen = false;
let settings = {
  intervalMs: 10000,
  theme: "auto",
  language: "nl"
};

const translationsConfig = window.BB_TRANSLATIONS || {};
const i18n = translationsConfig.i18n || { nl: {} };
const localWordLabels = translationsConfig.localWordLabels || {};
const vehicleFieldLabels = translationsConfig.vehicleFieldLabels || {};
const localeMap = translationsConfig.localeMap || { nl: "nl-NL" };
const delayLexicon = translationsConfig.delayLexicon || {};

const DEFAULT_LANG = "nl";
const FALLBACK_LANG = "en";

function translateKey(key, language = settings.language) {
  return (
    i18n[language]?.[key] ??
    i18n[FALLBACK_LANG]?.[key] ??
    i18n[DEFAULT_LANG]?.[key] ??
    key
  );
}

const t = (key) => translateKey(key);
const localWord = (key) =>
  localWordLabels[key]?.[settings.language] ??
  localWordLabels[key]?.[FALLBACK_LANG] ??
  localWordLabels[key]?.[DEFAULT_LANG] ??
  key;

function normalizeFieldKey(key) {
  return (key || "")
    .toString()
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}

function translateVehicleFieldLabel(key) {
  const normalized = normalizeFieldKey(key);
  return (
    vehicleFieldLabels[settings.language]?.[normalized] ||
    vehicleFieldLabels[FALLBACK_LANG]?.[normalized] ||
    vehicleFieldLabels[DEFAULT_LANG]?.[normalized] ||
    key
  );
}

const localeForLanguage = (lang) => localeMap[lang] || localeMap[FALLBACK_LANG] || localeMap[DEFAULT_LANG] || "nl-NL";

function formatDelayMessage(delayMinutes) {
  const lex =
    delayLexicon[settings.language] ||
    delayLexicon[FALLBACK_LANG] ||
    delayLexicon[DEFAULT_LANG] ||
    { minute: "min", early: "early", late: "delay", onTime: "On time" };
  if (delayMinutes < 0) return `${Math.abs(delayMinutes)} ${lex.minute} ${lex.early}`;
  if (delayMinutes > 0) return `${delayMinutes} ${lex.minute} ${lex.late}`;
  return lex.onTime;
}

function isIosInstallable() {
  const ua = window.navigator.userAgent;
  const isIos = /iPhone|iPad|iPod/.test(ua);
  const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
  return isIos && !isStandalone;
}

function loadSettings() {
  try {
    const raw = localStorage.getItem(SETTINGS_KEY);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    settings = { ...settings, ...parsed };
  } catch (e) {
    console.warn("Settings laden mislukt", e);
  }
}

function saveSettings() {
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
}

function applyTheme(theme) {
  const root = document.documentElement;
  if (theme === "auto") root.removeAttribute("data-theme");
  else root.setAttribute("data-theme", theme);
}

function applyTranslations() {
  appSubtitleEl.textContent = t("subtitle");
  installBtn.textContent = t("install");
  settingsToggleBtn.title = t("settings");
  settingsToggleBtn.setAttribute("aria-label", t("settings"));
  iosInstallHintEl.textContent = t("iosHint");
  searchBtn.textContent = t("search");
  voertuigInput.placeholder = t("vehiclePlaceholder");
  favoritesTitleEl.textContent = t("favorites");
  settingsTitleEl.textContent = t("settings");
  intervalLabelEl.textContent = t("interval");
  themeLabelEl.textContent = t("theme");
  languageLabelEl.textContent = t("language");
  intervalOpt5El.textContent = `5 ${t("intervalSeconds")}`;
  intervalOpt10El.textContent = `10 ${t("intervalSeconds")}`;
  intervalOpt15El.textContent = `15 ${t("intervalSeconds")}`;
  intervalOpt30El.textContent = `30 ${t("intervalSeconds")}`;
  themeAutoOptEl.textContent = t("themeAuto");
  themeLightOptEl.textContent = t("themeLight");
  themeDarkOptEl.textContent = t("themeDark");
  staticCardTitleEl.textContent = t("staticCard");
  realtimeCardTitleEl.textContent = t("realtimeCard");
  disclaimerTitleEl.textContent = t("disclaimerTitle");
  disclaimerTextEl.textContent = t("disclaimerText");
  lastUpdateEl.textContent = `${t("lastUpdate")}: -`;
  if (!currentVehicleId) {
    realtimeEl.innerHTML = t("noData");
    vasteDataEl.innerHTML = t("noneSelected");
  }
  updateFavoriteButtonState();
  updateFollowButtonText();
}

function setSettingsPanel(open) {
  settingsOpen = !!open;
  document.body.classList.toggle("settings-open", settingsOpen);
  settingsPanelEl.setAttribute("aria-hidden", String(!settingsOpen));
  settingsPanelEl.toggleAttribute("inert", !settingsOpen);
  settingsToggleBtn.setAttribute("aria-expanded", String(settingsOpen));
  settingsToggleBtn.classList.toggle("active", settingsOpen);
}

function loadFavorites() {
  try {
    favorites = JSON.parse(localStorage.getItem(FAVORITES_KEY) || "[]");
    if (!Array.isArray(favorites)) favorites = [];
  } catch (e) {
    favorites = [];
  }
}

function saveFavorites() {
  localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
}

function renderFavorites() {
  favoritesListEl.innerHTML = "";
  if (!favorites.length) {
    const empty = document.createElement("span");
    empty.className = "loading";
    empty.textContent = t("noFavoritesYet");
    favoritesListEl.appendChild(empty);
    return;
  }
  favorites.forEach((id) => {
    const chip = document.createElement("button");
    chip.type = "button";
    chip.className = "chip";
    chip.textContent = id;
    chip.addEventListener("click", () => {
      voertuigInput.value = id;
      zoekAlles();
    });
    favoritesListEl.appendChild(chip);
  });
}

function updateFavoriteButtonState() {
  const id = voertuigInput.value.trim();
  const isFav = favorites.includes(id);
  favoriteBtn.textContent = isFav ? t("favoriteRemove") : t("favoriteAdd");
}

function toggleFavorite() {
  const id = voertuigInput.value.trim();
  if (!id) return;
  if (favorites.includes(id)) {
    favorites = favorites.filter((x) => x !== id);
  } else {
    favorites.unshift(id);
    favorites = [...new Set(favorites)].slice(0, 20);
  }
  saveFavorites();
  renderFavorites();
  updateFavoriteButtonState();
}

function restartRealtimeRefresh() {
  if (refresh) clearInterval(refresh);
  if (!currentVehicleId) return;
  refresh = setInterval(() => updateRealtime(currentVehicleId), updateIntervalMs);
}

function updateFollowButtonText() {
  followToggleBtn.textContent = followVehicle ? t("followOn") : t("followOff");
}

function initAppPreferences() {
  loadSettings();
  loadFavorites();
  updateIntervalMs = Number(settings.intervalMs) || 10000;
  intervalSelect.value = String(updateIntervalMs);
  themeSelect.value = settings.theme;
  languageSelect.value = settings.language;
  applyTheme(settings.theme);
  applyTranslations();
  setSettingsPanel(false);
  renderFavorites();
  updateFavoriteButtonState();

  if (isIosInstallable()) {
    iosInstallHintEl.hidden = false;
  }
}

searchBtn.addEventListener("click", zoekAlles);
favoriteBtn.addEventListener("click", toggleFavorite);
voertuigInput.addEventListener("input", updateFavoriteButtonState);
followToggleBtn.addEventListener("click", () => {
  followVehicle = !followVehicle;
  if (followVehicle) userInteracted = false;
  updateFollowButtonText();
});
intervalSelect.addEventListener("change", () => {
  settings.intervalMs = Number(intervalSelect.value);
  updateIntervalMs = settings.intervalMs;
  saveSettings();
  restartRealtimeRefresh();
});
themeSelect.addEventListener("change", () => {
  settings.theme = themeSelect.value;
  saveSettings();
  applyTheme(settings.theme);
});
languageSelect.addEventListener("change", () => {
  settings.language = languageSelect.value;
  saveSettings();
  applyTranslations();
  renderFavorites();
});
settingsToggleBtn.addEventListener("click", () => setSettingsPanel(!settingsOpen));
settingsCloseBtn.addEventListener("click", () => setSettingsPanel(false));
settingsBackdropEl.addEventListener("click", () => setSettingsPanel(false));
document.addEventListener("keydown", (event) => {
  if (event.key === "Escape" && settingsOpen) {
    setSettingsPanel(false);
  }
});

// Helper: CSV parser that respects quoted fields
function parseCSVLine(line){
  const fields = [];
  let cur = "";
  let inQuotes = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"') { cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if(ch === ',' && !inQuotes){
      fields.push(cur);
      cur = "";
    } else { cur += ch; }
  }
  fields.push(cur);
  return fields.map(f => f.trim().replace(/^"|"$/g, ''));
}

// Helper: normalize ids/strings for matching
const normalize = s => (s||"").toString().replace(/"/g, "").trim();

// Custom bus pin as DivIcon so we can rotate the image based on bearing
const busIcon = L.divIcon({
  className: 'bus-div-icon',
  html: `<img src="navicon.png" style="width:36px;height:36px;transform:rotate(0deg);display:block;transform-origin:18px 28px;transition: transform 0.25s linear;"/>`,
  iconSize: [36,36],
  iconAnchor: [18,36]
});

async function laadVoertuigen() {
  const res = await fetch(`${BASE_URL}/vehicles.txt`, { cache: "no-store" });
  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = regels[0].split(";");

  voertuigen = regels.slice(1).map(r => {
    const v = r.split(";");
    const obj = {};
    headers.forEach((h,i)=>obj[h.trim()] = v[i]?.trim() || "/");
    return obj;
  });
}

async function laadTrips() {
  const res = await fetch(`${BASE_URL}/trips.txt`, { cache: "no-store" });
  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = parseCSVLine(regels[0]).map(h => h.trim());

  trips = regels.slice(1).map(r => {
    const values = parseCSVLine(r);
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i] || "/");
    return obj;
  });
}

async function laadRoutes() {
  const res = await fetch(`${BASE_URL}/routes.txt`, { cache: "no-store" });
  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = parseCSVLine(regels[0]).map(h => h.trim());

  routes = regels.slice(1).map(r => {
    const values = parseCSVLine(r);
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i] || "/");
    return obj;
  });
}

initAppPreferences();
laadVoertuigen();
laadTrips();
laadRoutes();

function toonSuggesties() {
  const q = voertuigInput.value.toLowerCase();
  suggestieLijst.innerHTML = "";
  if(!q) return;

  voertuigen.filter(v => v.Voertuignummer?.toLowerCase().startsWith(q))
    .slice(0,8)
    .forEach(v=>{
      const li=document.createElement("li");
      li.textContent = `${v.Voertuignummer} - ${v.Type}`;
      li.onclick=()=>{
        voertuigInput.value=v.Voertuignummer;
        suggestieLijst.innerHTML="";
        voertuigInput.blur(); // Focus weghalen zodat geen enter meer nodig is
        zoekAlles();
      };
      suggestieLijst.appendChild(li);
    });
}

async function zoekAlles() {
  const id = voertuigInput.value.trim();
  if(!id) return;
  currentVehicleId = id;
  followVehicle = true;
  userInteracted = false;
  updateFollowButtonText();
  updateFavoriteButtonState();

  suggestieLijst.innerHTML = "";
  resultsGridEl.classList.add("show");
  closeBtnEl.style.display = "block";

  toonVasteData(id);

  if (voertuigen.length === 0) await laadVoertuigen();
  const bus = findBusById(id);
  if (isOutOfService(bus)) {
    realtimeEl.innerHTML = t("outOfServiceNoRealtime");
    mapEl.classList.add("hidden");
    routeTrail = [];
    if (trailLine && map) {
      map.removeLayer(trailLine);
      trailLine = null;
    }
    if (marker && map) {
      map.removeLayer(marker);
      marker = null;
    }
    lastUpdateEl.textContent = `${t("lastUpdate")}: -`;
    if(refresh) {
      clearInterval(refresh);
      refresh = null;
    }
    return;
  }

  realtimeEl.innerHTML = `<span class='spinner'></span><span class='loading'>${t("loading")}</span>`;
  routeTrail = [];
  if (trailLine && map) {
    map.removeLayer(trailLine);
    trailLine = null;
  }

  updateRealtime(id);
  if(refresh) clearInterval(refresh);
  refresh = setInterval(()=>updateRealtime(id), updateIntervalMs);
}

function terug() {
  resultsGridEl.classList.remove("show");
  closeBtnEl.style.display = "none";
  realtimeEl.innerHTML = t("noData");
  vasteDataEl.innerHTML = t("noneSelected");
  voertuigInput.value = "";
  currentVehicleId = "";
  routeTrail = [];
  if(refresh) {
    clearInterval(refresh);
    refresh = null;
  }
  if (trailLine && map) {
    map.removeLayer(trailLine);
    trailLine = null;
  }
  lastUpdateEl.textContent = `${t("lastUpdate")}: -`;
  if(marker){ map.removeLayer(marker); marker=null; }
  updateFavoriteButtonState();
}

function findBusById(id) {
  return voertuigen.find(v =>
    v.Voertuignummer === id ||
    v["Hansea nummer"] === id ||
    v["Oude voertuignummers"]?.split(/[, ]+/).includes(id) ||
    v["Oude nummerplaten"]?.split(/[, ]+/).includes(id)
  );
}

function isOutOfService(bus) {
  if (!bus) return false;
  const outKeys = Object.keys(bus).filter(k => k.toLowerCase().includes("uit dienst"));
  for (const k of outKeys) {
    const val = (bus[k] || "").toString().trim();
    if (val && val !== "/") return true;
  }
  return false;
}

function toonVasteData(id){
  const bus = findBusById(id);

  if(!bus){
    vasteDataEl.innerHTML=t("noFixed");
    return;
  }

  let html=`<p class="voertuignummer-display">${bus.Voertuignummer}</p>`;
  if(bus.Type) html += `<p class="vehicle-type">${bus.Type}</p>`;
  html+="<table>";
  for(const [k,v] of Object.entries(bus)){
    if(k==="Vervoersmaatschappij"||k==="Voertuignummer"||k==="Type") continue;

    let waarde = v;
    const key = k.toLowerCase();

    if(key.includes("datum in dienst") && v!=="/") {
      waarde = new Date(v).toLocaleDateString(localeForLanguage(settings.language),{year:'numeric',month:'long',day:'numeric'});
    } else if(key.includes("uit dienst")) {
      if(v==="/") waarde = t("notOutOfService");
      else waarde = new Date(v).toLocaleDateString(localeForLanguage(settings.language),{year:'numeric',month:'long',day:'numeric'});
    } else if(key.includes("datum") && v!=="/") {
      waarde = new Date(v).toLocaleDateString(localeForLanguage(settings.language),{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    } else {
      if(v==="/") continue;
    }
    html+=`<tr><th>${translateVehicleFieldLabel(k)}</th><td>${waarde}</td></tr>`;
  }
  html+="</table>";
  const igUrl = 'https://www.instagram.com/explore/search/keyword/?q=' + encodeURIComponent('#dl' + id);
  html += `<p class="ig-btn-wrap"><a class="btn btn--instagram" href="${igUrl}" target="_blank" rel="noopener">${localWord("instagramSearch")}</a></p>`;
  vasteDataEl.innerHTML=html;
}

function initMap(lat,lon){
  if(!map){
    map=L.map("map").setView([lat,lon],14);

    // Cleaner base map suitable for transit (CartoDB Positron)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors &amp; <a href="https://carto.com/">CARTO</a>'
    }).addTo(map);

    // Optional transport overlay (rail/lines) - may enhance transit visualization
    const transportOverlay = L.tileLayer('https://a.tile.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenRailwayMap'
    });
    transportOverlay.addTo(map);

    // Detect user interactions to stop auto-centering
    map.on('dragstart zoomstart movestart touchstart', ()=>{
      userInteracted = true;
      followVehicle = false;
      updateFollowButtonText();
      if(centerControl) centerControl.getContainer().style.display = 'block';
    });

    // Create a custom control (button) to re-center the map
    const CenterControl = L.Control.extend({
      onAdd: function(map){
        const el = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const btn = L.DomUtil.create('a', 'map-center-btn', el);
        btn.innerHTML = 'C';
        btn.title = 'Centreren';
        btn.href = '#';
        btn.style.display = 'none';
        btn.style.width = '30px';
        btn.style.height = '30px';
        btn.style.lineHeight = '30px';
        btn.style.textAlign = 'center';

        L.DomEvent.on(btn, 'click', L.DomEvent.stopPropagation)
                 .on(btn, 'click', L.DomEvent.preventDefault)
                 .on(btn, 'click', ()=>{
                   if(marker){
                     map.setView(marker.getLatLng(), Math.max(map.getZoom(), 15));
                     userInteracted = false;
                     followVehicle = true;
                     updateFollowButtonText();
                     btn.style.display = 'none';
                   }
                 });

        return el;
      }
    });

    centerControl = new CenterControl({ position: 'topright' });
    centerControl.addTo(map);
  }
}

function getTripUpdateForVehicle(entities, vehicleId) {
  const match = entities.find(e => e.tripUpdate?.vehicle?.id == vehicleId);
  return match?.tripUpdate || null;
}

function getDelaySecondsFromTripUpdate(tripUpdate) {
  if (!tripUpdate?.stopTimeUpdate?.length) return null;
  const now = Math.floor(Date.now() / 1000);
  let best = null;

  for (const stop of tripUpdate.stopTimeUpdate) {
    const candidates = [stop.departure, stop.arrival];
    for (const c of candidates) {
      if (!c || typeof c.delay !== "number") continue;
      const score = typeof c.time === "number" ? Math.abs(c.time - now) : Number.MAX_SAFE_INTEGER;
      if (!best || score < best.score) {
        best = { delay: c.delay, score };
      }
    }
  }
  return best ? best.delay : null;
}

async function updateRealtime(id){
  try{
    const res = await fetch(API_URL);
    const data = await res.json();
    const entities = Array.isArray(data.entity) ? data.entity : [];

    const gps = [...entities].reverse().find(e=>e.vehicle?.vehicle?.id==id && e.vehicle.position);

    if(!gps){ realtimeEl.innerHTML=t("noData"); mapEl.classList.add("hidden"); return; }

    const v=gps.vehicle;
    const tripid = gps.vehicle.trip?.tripId || gps.vehicle.trip?.trip_id || "";

    // Zorg dat trips/routes geladen zijn
    if(trips.length===0) await laadTrips();
    if(routes.length===0) await laadRoutes();

    // Robuuste matching: normaliseer en probeer exact / endsWith / includes
    const nTripId = normalize(tripid);
    let tripData = trips.find(t => normalize(t.trip_id) === nTripId);
    if(!tripData && nTripId){
      tripData = trips.find(t => {
        const tId = normalize(t.trip_id);
        return tId && (
          tId === nTripId ||
          tId.endsWith(nTripId) ||
          nTripId.endsWith(tId) ||
          tId.includes(nTripId) ||
          nTripId.includes(tId)
        );
      });
    }
    

    const routeId = tripData?.route_id || "";
    let routeData = routes.find(r => r.route_id === routeId);
    if(!routeData && routeId){
      routeData = routes.find(r => r.route_id && (
        r.route_id === routeId ||
        r.route_id.includes(routeId) ||
        routeId.includes(r.route_id)
      ));
    }

    const routeShort = routeData?.route_short_name || "?";
    const routeLong = routeData?.route_long_name || "";
    const tripShort = tripData ? (tripData.trip_headsign || tripData.trip_short_name || "") : "";
    const routeColorRaw = (routeData?.route_color || "").replace(/[^0-9a-fA-F]/g, "").slice(0, 6);
    const routeTextColorRaw = (routeData?.route_text_color || "").replace(/[^0-9a-fA-F]/g, "").slice(0, 6);
    const routeColor = routeColorRaw.length === 6 ? `#${routeColorRaw}` : "#2563eb";
    const routeTextColor = routeTextColorRaw.length === 6 ? `#${routeTextColorRaw}` : "#ffffff";

    // Delay from trip updates is authoritative; fallback to vehicle payload
    const tripUpdate = getTripUpdateForVehicle(entities, id);
    let delaySeconds = getDelaySecondsFromTripUpdate(tripUpdate);
    if (typeof delaySeconds !== "number" && typeof gps.vehicle.trip?.delay === "number") {
      delaySeconds = gps.vehicle.trip.delay;
    }
    if (typeof delaySeconds !== "number" && typeof v.stopStatus?.delay === "number") {
      delaySeconds = v.stopStatus.delay;
    }
    if (typeof delaySeconds !== "number") delaySeconds = 0;
    delayMinutes = delaySeconds < 0
      ? -Math.round(Math.abs(delaySeconds) / 60)
      : Math.round(delaySeconds / 60);
    
    const msgDelay = formatDelayMessage(delayMinutes);
    const delayClass = delayMinutes < 0 ? "delay-early" : delayMinutes > 0 ? "delay-late" : "delay-ontime";

    realtimeEl.innerHTML=`
      <p>
        <div class="route-destination-row">
          <span class="line-badge" style="background:${routeColor};color:${routeTextColor};">${routeShort}</span>
          <span class="destination-text">${tripShort || "-"}</span>
        </div>
        <span class="delay-status ${delayClass}">${msgDelay}</span>
      </p>
    `;
    mapEl.classList.remove("hidden");
    lastUpdateEl.textContent = `${t("lastUpdate")}: ${new Date().toLocaleTimeString(localeForLanguage(settings.language))}`;

    initMap(v.position.latitude,v.position.longitude);
    routeTrail.push([v.position.latitude, v.position.longitude]);
    if (routeTrail.length > 35) routeTrail.shift();
    if (routeTrail.length >= 2) {
      if (!trailLine) {
        trailLine = L.polyline(routeTrail, { color: "#ef4444", weight: 4, opacity: 0.75 }).addTo(map);
      } else {
        trailLine.setLatLngs(routeTrail);
      }
    }

    if (followVehicle) {
      map.setView([v.position.latitude,v.position.longitude],15);
    }

    const bearing = v.position.bearing || 0;

    if(marker) {
      marker.setLatLng([v.position.latitude,v.position.longitude]);
      marker.setPopupContent(`${localWord("vehicle")} ${id}<br>${localWord("line")} ${routeShort}<br>${localWord("destination")}: ${tripShort}<br>${localWord("delay")}: ${msgDelay}`);
      // update rotation of img inside divIcon
      const el = marker.getElement && marker.getElement();
      if(el){
        const img = el.querySelector('img');
        if(img) img.style.transform = `rotate(${bearing}deg)`;
      }
    } else {
      marker = L.marker([v.position.latitude,v.position.longitude], { icon: busIcon })
        .addTo(map)
        .bindPopup(`${localWord("vehicle")} ${id}<br>${localWord("line")} ${routeShort}<br>${localWord("destination")}: ${tripShort}<br>${localWord("delay")}: ${msgDelay}`)
        .openPopup();
      // set initial rotation
      const el = marker.getElement && marker.getElement();
      if(el){
        const img = el.querySelector('img');
        if(img) img.style.transform = `rotate(${bearing}deg)`;
      }
    }

  }catch(e){ console.error(e); realtimeEl.innerHTML = t("realtimeError"); }
}
</script>

<!-- Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .catch(err => console.error('Service Worker registratie mislukt:', err));
}
</script>
</body>
</html>

