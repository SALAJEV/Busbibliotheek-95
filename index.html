<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Busbibliotheek Live</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>

<body>
<div class="container">

  <h1>ğŸšŒ Busbibliotheek Live</h1>
  <p>Zoek een voertuig en volg â€˜m live.</p>

  <input id="voertuignummer" placeholder="Voertuignummer" oninput="toonSuggesties()">
  <ul id="suggestielijst"></ul>

  <button onclick="zoekAlles()">Zoeken</button>

  <div class="grid">
    <div class="card">
      <h2>ğŸ“‹ Voertuiginfo</h2>
      <div id="vasteData">Nog geen voertuig geselecteerd.</div>
    </div>

    <div class="card">
      <h2>ğŸ“ Realtime</h2>
      <div id="realtime">Nog geen data.</div>
      <div id="map"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
let voertuigen = [];
let map, marker, refresh;

/* ===============================
   LAAD VOERTUIGEN (PUNTKOMMA)
================================ */
async function laadVoertuigen() {
  const res = await fetch(
    "https://pub-611b5bc156eb455ba86d9bcece9aea1c.r2.dev/vehicles.txt",
    { cache: "no-store" }
  );

  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = regels[0].split(";");

  voertuigen = regels.slice(1).map(r => {
    const v = r.split(";");
    const obj = {};
    headers.forEach((h, i) => {
      obj[h.trim()] = v[i]?.trim() || "/";
    });
    return obj;
  });

  console.log("âœ… voertuigen geladen:", voertuigen.length);
  console.log("ğŸ” test:", voertuigen[0]);
}
laadVoertuigen();

/* ===============================
   SUGGESTIES
================================ */
function toonSuggesties() {
  const q = voertuignummer.value.toLowerCase();
  suggestielijst.innerHTML = "";
  if (!q) return;

  voertuigen
    .filter(v => v.Voertuignummer?.startsWith(q))
    .slice(0, 8)
    .forEach(v => {
      const li = document.createElement("li");
      li.textContent = `${v.Voertuignummer} â€“ ${v.Type}`;
      li.onclick = () => {
        voertuignummer.value = v.Voertuignummer;
        suggestielijst.innerHTML = "";
        zoekAlles();
      };
      suggestielijst.appendChild(li);
    });
}

/* ===============================
   ZOEK ALLES
================================ */
function zoekAlles() {
  const id = voertuignummer.value.trim();
  if (!id) return;

  toonVasteData(id);
  updateRealtime(id);

  if (refresh) clearInterval(refresh);
  refresh = setInterval(() => updateRealtime(id), 10000);
}

/* ===============================
   VASTE DATA
================================ */
function toonVasteData(id) {
  const bus = voertuigen.find(v =>
    v.Voertuignummer === id ||
    v["Hansea nummer"] === id ||
    v["Oude voertuignummers"]?.split(/[, ]+/).includes(id) ||
    v["Oude nummerplaten"]?.split(/[, ]+/).includes(id)
  );

  if (!bus) {
    vasteData.innerHTML = "âŒ Geen voertuigdata gevonden.";
    return;
  }

  let html = "<table>";
  for (const [k, v] of Object.entries(bus)) {
    if (v !== "/" && k !== "Vervoersmaatschappij") {
      html += `
        <tr>
          <th>${k}</th>
          <td>${v}</td>
        </tr>`;
    }
  }
  html += "</table>";

  vasteData.innerHTML = html;
}

/* ===============================
   MAP
================================ */
function initMap(lat, lon) {
  map = L.map("map").setView([lat, lon], 14);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap"
  }).addTo(map);
}

/* ===============================
   REALTIME
================================ */
async function updateRealtime(id) {
  try {
    const res = await fetch("https://busbibliotheek95.pages.dev/api");
    const data = await res.json();

    const gps = data.entity
      .reverse()
      .find(e => e.vehicle?.vehicle?.id == id && e.vehicle.position);

    if (!gps) {
      realtime.innerHTML = "âŒ Geen realtime data.";
      return;
    }

    const v = gps.vehicle;

    realtime.innerHTML = `
      <p>
        <b>Latitude:</b> ${v.position.latitude}<br>
        <b>Longitude:</b> ${v.position.longitude}<br>
        <b>Richting:</b> ${v.position.bearing}Â°
      </p>
    `;

    if (!map) initMap(v.position.latitude, v.position.longitude);
    map.setView([v.position.latitude, v.position.longitude], 15);

    if (marker)
      marker.setLatLng([v.position.latitude, v.position.longitude]);
    else
      marker = L.marker([v.position.latitude, v.position.longitude])
        .addTo(map)
        .bindPopup(`Voertuig ${id}`)
        .openPopup();

  } catch (e) {
    console.error(e);
    realtime.innerHTML = "âš ï¸ Fout bij realtime data.";
  }
}
</script>
</body>
</html>