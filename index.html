<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Busbibliotheek Live</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root {
  --primary:#007bff;
  --bg:#f9fafb;
  --bg-dark:#121212;
  --card:#fff;
  --card-dark:#1e1e1e;
}

body {
  margin:0;
  font-family:Inter,sans-serif;
  background:var(--bg);
}

body.dark { background:var(--bg-dark); color:#fff; }

.container {
  max-width:1200px;
  margin:2rem auto;
  padding:1rem;
}

input,button {
  width:100%;
  padding:1rem;
  border-radius:.75rem;
  margin-top:.5rem;
}

button {
  background:var(--primary);
  color:#fff;
  border:none;
  font-weight:600;
}

.grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:1rem;
  margin-top:1rem;
}

.card {
  background:var(--card);
  padding:1rem;
  border-radius:1rem;
}

body.dark .card { background:var(--card-dark); }

table {
  width:100%;
  border-collapse:collapse;
}

th,td {
  padding:.5rem;
  border-bottom:1px solid #ccc;
  text-align:left;
}

#map {
  height:320px;
  margin-top:1rem;
  border-radius:1rem;
}
</style>
</head>

<body>
<div class="container">

<h1>üöå Busbibliotheek Live</h1>

<input id="input" placeholder="Voertuignummer">
<button onclick="zoek()">Zoeken</button>

<div class="grid">
  <div class="card">
    <h2>Voertuiginfo</h2>
    <div id="vaste">‚Äì</div>
  </div>

  <div class="card">
    <h2>Realtime</h2>
    <div id="rt">‚Äì</div>
    <div id="map"></div>
  </div>
</div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let voertuigen = [];
let map, marker, timer;

/* ==== VEHICLES LADEN (ROBUST) ==== */
async function laadVoertuigen() {
  const res = await fetch(
    "https://pub-611b5bc156eb455ba86d9bcece9aea1c.r2.dev/vehicles.txt",
    { cache:"no-store" }
  );

  const text = await res.text();
  const lines = text.trim().split("\n");

  // headers normaliseren
  const rawHeaders = lines[0].split(";").map(h =>
    h.replace(/\ufeff/g,"").trim().toLowerCase()
  );

  voertuigen = lines.slice(1).map(line => {
    const vals = line.split(";");
    const obj = {};
    rawHeaders.forEach((h,i)=>{
      obj[h] = (vals[i] || "").trim();
    });
    return obj;
  });

  console.log("geladen voertuigen:", voertuigen[0]);
}

laadVoertuigen();

/* ==== ZOEKEN IN VOERTUIGEN ==== */
function zoek() {
  const q = input.value.trim().toLowerCase();
  if(!q) return;

  const bus = voertuigen.find(v =>
    v.voertuignummer === q ||
    v["hansea nummer"] === q ||
    v["oude voertuignummers"]?.split(/[, ]+/).includes(q) ||
    v["oude nummerplaten"]?.split(/[, ]+/).includes(q)
  );

  if(!bus) {
    vaste.innerHTML = "‚ùå Geen voertuig gevonden.";
    return;
  }

  let html = "<table>";
  Object.entries(bus).forEach(([k,v])=>{
    if(v && v !== "/"){
      html += `<tr><th>${k}</th><td>${v}</td></tr>`;
    }
  });
  html += "</table>";

  vaste.innerHTML = html;

  startRealtime(q);
}

/* ==== MAP ==== */
function initMap(lat,lon){
  map = L.map("map").setView([lat,lon],14);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
}

/* ==== REALTIME ==== */
async function startRealtime(id){
  if(timer) clearInterval(timer);
  await updateRealtime(id);
  timer = setInterval(()=>updateRealtime(id),10000);
}

async function updateRealtime(id){
  try{
    const res = await fetch("https://busbibliotheek95.pages.dev/api");
    const data = await res.json();

    const gps = [...data.entity]
      .reverse()
      .find(e => e.vehicle?.vehicle?.id == id && e.vehicle?.position);

    if(!gps){
      rt.innerHTML = "Geen GPS.";
      return;
    }

    const p = gps.vehicle.position;
    rt.innerHTML = `Lat ${p.latitude}<br>Lon ${p.longitude}`;

    if(!map) initMap(p.latitude,p.longitude);
    map.setView([p.latitude,p.longitude],15);

    if(marker) marker.setLatLng([p.latitude,p.longitude]);
    else marker = L.marker([p.latitude,p.longitude]).addTo(map);

  }catch(e){
    rt.innerHTML = "Realtime fout.";
  }
}
</script>
</body>
</html>