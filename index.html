<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Zoek een voertuig en volg 'm live.">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Busbibliotheek">
<link rel="apple-touch-icon" href="logo.png">
<link rel="manifest" href="manifest.json">
<title>Busbibliotheek</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<link rel="stylesheet" href="style.css">
</head>
<body>
<div id="splash" role="img" aria-label="Busbibliotheek laden">
  <picture class="logo">
    <!-- Use a light (high-contrast) logo on dark themes, and a dark logo on light themes -->
    <source media="(prefers-color-scheme: dark)" srcset="logo_light.png">
    <source media="(prefers-color-scheme: light)" srcset="logo_dark.png">
    <img src="logo.png" alt="Busbibliotheek">
  </picture>
</div>
<div class="container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
    <div>
      <h1>Busbibliotheek</h1>
      <p>Zoekt een voertuig op en volg het in realtime.</p>
    </div>
    <button id="installBtn" title="App installeren op thuisscherm">Installeer App</button>
  </div>

  <input id="voertuignummer" placeholder="Voertuignummer" 
         oninput="toonSuggesties()" 
         onkeydown="if(event.key==='Enter'){zoekAlles();}" autocomplete="off">
  <ul id="suggestielijst"></ul>

  <div class="grid" id="resultsGrid">
    <button class="close-btn" id="closeBtn" style="display:none; position: absolute; top: 2rem; right: 1.5rem; z-index: 100;" onclick="terug()" title="Venster sluiten" aria-label="Sluiten">×</button>
    <div class="card">
      <h2>Voertuiginformatie</h2>
      <div id="vasteData">Geen voertuig geselecteerd.</div>
    </div>

    <div class="card">
      <h2>Realtimegegevens</h2>
      <div id="realtime" class="loading">Geen gegevens beschikbaar.</div>
      <div id="map"></div>
    </div>
  </div>

  <footer style="margin-top: 4rem; padding: 2rem; border-top: 1px solid var(--border); color: var(--muted); font-size: 0.9rem;">
    <h3>Disclaimer</h3>
    <p style="margin-top: 0.5rem; line-height: 1.6;">De informatie op deze website wordt verstrekt zonder garanties. Busbibliotheek is niet aansprakelijk voor vertraging, fouten of onnauwkeurigheden in realtime gegevens. Gebruikers raadplegen deze informatie geheel op eigen risico. Raadpleeg voor officiële ritinformatie de bevoegde vervoersmaatschappij.</p>
  </footer>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Splash controls (mobile-first startup experience)
const splash = document.getElementById("splash");
function hideSplash(ms = 350) {
  const s = splash;
  if (!s) return;
  s.classList.add("hidden");
  setTimeout(() => { if (s.parentNode) s.parentNode.removeChild(s); document.querySelector('.grid')?.classList.add('show'); }, ms + 50);
}
window.addEventListener('load', () => setTimeout(hideSplash, 700));
splash?.addEventListener('click', () => hideSplash(150));
document.addEventListener('touchstart', () => hideSplash(150), { once: true });

// Install Prompt (beter gecontroleerde PWA-installatie)
let deferredPrompt = null;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.classList.add('show');
});
installBtn.addEventListener('click', async () => {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    console.log(`Gebruiker antwoord: ${outcome}`);
    deferredPrompt = null;
    installBtn.classList.remove('show');
  }
});
window.addEventListener('appinstalled', () => {
  console.log('App succesvol geïnstalleerd');
  installBtn.classList.remove('show');
  deferredPrompt = null;
});

// Constants
const BASE_URL = "https://pub-611b5bc156eb455ba86d9bcece9aea1c.r2.dev";
const API_URL = "https://busbibliotheek95.pages.dev/api";
const TIME_UPDATE = 10000; // 10 seconds

let voertuigen = [];
let trips = [];
let routes = [];
let map, marker, refresh;
let userInteracted = false;
let centerControl;
let delayMinutes = 0;

// Helper: CSV parser that respects quoted fields
function parseCSVLine(line){
  const fields = [];
  let cur = "";
  let inQuotes = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){
      if(inQuotes && line[i+1] === '"') { cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if(ch === ',' && !inQuotes){
      fields.push(cur);
      cur = "";
    } else { cur += ch; }
  }
  fields.push(cur);
  return fields.map(f => f.trim().replace(/^"|"$/g, ''));
}

// Helper: normalize ids/strings for matching
const normalize = s => (s||"").toString().replace(/"/g, "").trim();

// Custom bus pin as DivIcon so we can rotate the image based on bearing
const busIcon = L.divIcon({
  className: 'bus-div-icon',
  html: `<img src="navicon.png" style="width:36px;height:36px;transform:rotate(0deg);display:block;transform-origin:18px 28px;transition: transform 0.25s linear;"/>`,
  iconSize: [36,36],
  iconAnchor: [18,36]
});

async function laadVoertuigen() {
  const res = await fetch(`${BASE_URL}/vehicles.txt`, { cache: "no-store" });
  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = regels[0].split(";");

  voertuigen = regels.slice(1).map(r => {
    const v = r.split(";");
    const obj = {};
    headers.forEach((h,i)=>obj[h.trim()] = v[i]?.trim() || "/");
    return obj;
  });
}

async function laadTrips() {
  const res = await fetch(`${BASE_URL}/trips.txt`, { cache: "no-store" });
  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = parseCSVLine(regels[0]).map(h => h.trim());

  trips = regels.slice(1).map(r => {
    const values = parseCSVLine(r);
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i] || "/");
    return obj;
  });
}

async function laadRoutes() {
  const res = await fetch(`${BASE_URL}/routes.txt`, { cache: "no-store" });
  const text = await res.text();
  const regels = text.trim().split(/\r?\n/);
  const headers = parseCSVLine(regels[0]).map(h => h.trim());

  routes = regels.slice(1).map(r => {
    const values = parseCSVLine(r);
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i] || "/");
    return obj;
  });
}

laadVoertuigen();
laadTrips();
laadRoutes();

function toonSuggesties() {
  const q = voertuignummer.value.toLowerCase();
  suggestielijst.innerHTML = "";
  if(!q) return;

  voertuigen.filter(v => v.Voertuignummer?.toLowerCase().startsWith(q))
    .slice(0,8)
    .forEach(v=>{
      const li=document.createElement("li");
      li.textContent = `${v.Voertuignummer} – ${v.Type}`;
      li.onclick=()=>{
        voertuignummer.value=v.Voertuignummer;
        suggestielijst.innerHTML="";
        voertuignummer.blur(); // Focus weghalen zodat geen enter meer nodig is
        zoekAlles();
      };
      suggestielijst.appendChild(li);
    });
}

function zoekAlles() {
  const id = voertuignummer.value.trim();
  if(!id) return;

  suggestielijst.innerHTML = "";
  document.getElementById("resultsGrid").classList.add("show");
  document.getElementById("closeBtn").style.display = "block";

  toonVasteData(id);

  realtime.innerHTML = "<span class='spinner'></span><span class='loading'>Gegevens laden...</span>";

  updateRealtime(id);
  if(refresh) clearInterval(refresh);
  refresh = setInterval(()=>updateRealtime(id), TIME_UPDATE);
}

function terug() {
  document.getElementById("resultsGrid").classList.remove("show");
  document.getElementById("closeBtn").style.display = "none";
  realtime.innerHTML = "Geen gegevens beschikbaar.";
  vasteData.innerHTML = "Geen voertuig geselecteerd.";
  voertuignummer.value = "";
  if(marker){ map.removeLayer(marker); marker=null; }
}

function toonVasteData(id){
  const bus = voertuigen.find(v =>
    v.Voertuignummer===id ||
    v["Hansea nummer"]===id ||
    v["Oude voertuignummers"]?.split(/[, ]+/).includes(id) ||
    v["Oude nummerplaten"]?.split(/[, ]+/).includes(id)
  );

  if(!bus){
    vasteData.innerHTML="Geen voertuiggegevens gevonden.";
    return;
  }

  let html=`<p class="voertuignummer-display">${bus.Voertuignummer}</p>`;
  if(bus.Type) html += `<p style="font-size:1.1rem;font-weight:700;color:var(--text);margin-bottom:0.8rem;">${bus.Type}</p>`;
  html+="<table>";
  for(const [k,v] of Object.entries(bus)){
    if(k==="Vervoersmaatschappij"||k==="Voertuignummer"||k==="Type") continue;

    let waarde = v;
    const key = k.toLowerCase();

    if(key.includes("datum in dienst") && v!=="/") {
      waarde = new Date(v).toLocaleDateString("nl-NL",{year:'numeric',month:'long',day:'numeric'});
    } else if(key.includes("uit dienst")) {
      if(v==="/") waarde = "Niet uit dienst";
      else waarde = new Date(v).toLocaleDateString("nl-NL",{year:'numeric',month:'long',day:'numeric'});
    } else if(key.includes("datum") && v!=="/") {
      waarde = new Date(v).toLocaleDateString("nl-NL",{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    } else {
      if(v==="/") continue;
    }
    html+=`<tr><th>${k}</th><td>${waarde}</td></tr>`;
  }
  html+="</table>";
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- App stylesheet (centralized) -->
  <link rel="stylesheet" href="style.css">