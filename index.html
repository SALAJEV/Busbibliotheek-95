<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Busbibliotheek Live</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- Eigen CSS -->
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="container">

    <h1>üöå Busbibliotheek Live</h1>
    <p>Zoek een voertuig en volg ‚Äòm live.</p>

    <input
      id="voertuignummer"
      placeholder="Voertuignummer"
      oninput="toonSuggesties()"
    >
    <ul id="suggestielijst"></ul>

    <button onclick="zoekAlles()">Zoeken</button>

    <div class="grid">

      <!-- LINKS -->
      <div class="card">
        <h2>üìã Voertuiginfo</h2>
        <div id="vasteData">Nog geen voertuig geselecteerd.</div>
      </div>

      <!-- RECHTS -->
      <div class="card">
        <h2>üìç Realtime</h2>
        <div id="realtime">Nog geen data.</div>
        <div id="map"></div>
      </div>

    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    /* dark mode */
    if (window.matchMedia('(prefers-color-scheme: dark)').matches)
      document.body.classList.add('dark');

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener(
      'change',
      e => document.body.classList.toggle('dark', e.matches)
    );

    let voertuigen = [];
    let map, marker, refresh;

    /* LAAD VOERTUIGEN */
    async function laadVoertuigen() {
      const res = await fetch(
        "https://pub-611b5bc156eb455ba86d9bcece9aea1c.r2.dev/vehicles.txt",
        { cache: "no-store" }
      );

      const text = await res.text();
      const regels = text.trim().split("\n");
      const headers = regels[0].split(";");

      voertuigen = regels.slice(1).map(r => {
        const v = r.split(";");
        const o = {};
        headers.forEach((h, i) => o[h] = v[i]?.trim() || "/");
        return o;
      });

      console.log("Voertuigen geladen:", voertuigen.length);
    }
    laadVoertuigen();

    /* SUGGESTIES */
    function toonSuggesties() {
      const q = voertuignummer.value.toLowerCase();
      suggestielijst.innerHTML = "";
      if (!q) return;

      voertuigen
        .filter(v => v["Voertuignummer"].toLowerCase().startsWith(q))
        .slice(0, 8)
        .forEach(v => {
          const li = document.createElement("li");
          li.textContent = `${v.Voertuignummer} ‚Äì ${v.Type}`;
          li.onclick = () => {
            voertuignummer.value = v.Voertuignummer;
            suggestielijst.innerHTML = "";
            zoekAlles();
          };
          suggestielijst.appendChild(li);
        });
    }

    /* ZOEK ALLES */
    function zoekAlles() {
      const id = voertuignummer.value.trim();
      if (!id) return;

      toonVasteData(id);
      updateRealtime(id);

      if (refresh) clearInterval(refresh);
      refresh = setInterval(() => updateRealtime(id), 10000);
    }

    /* VASTE DATA */
    function toonVasteData(id) {
      const q = id.toLowerCase();

      const bus = voertuigen.find(v =>
        v["Voertuignummer"].toLowerCase() === q ||
        v["Hansea nummer"].toLowerCase() === q ||
        v["Oude voertuignummers"].toLowerCase().split(/[, ]+/).includes(q) ||
        v["Oude nummerplaten"].toLowerCase().split(/[, ]+/).includes(q)
      );

      if (!bus) {
        vasteData.innerHTML = "‚ùå Geen voertuigdata gevonden.";
        return;
      }

      let html = "<table>";
      Object.entries(bus).forEach(([k, v]) => {
        if (v !== "/" && k !== "Vervoersmaatschappij") {
          html += `
            <tr>
              <th>${k}</th>
              <td class="${k === "Hansea nummer" ? "hansea" : ""}">${v}</td>
            </tr>`;
        }
      });
      html += "</table>";

      vasteData.innerHTML = html;
    }

    /* MAP */
    function initMap(lat, lon) {
      map = L.map("map").setView([lat, lon], 14);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap"
      }).addTo(map);
    }

    /* REALTIME */
    async function updateRealtime(id) {
      try {
        const res = await fetch("https://busbibliotheek95.pages.dev/api");
        const data = await res.json();

        const matches = data.entity.filter(e =>
          e.vehicle?.vehicle?.id == id ||
          e.tripUpdate?.vehicle?.id == id
        );

        if (!matches.length) {
          realtime.innerHTML = "‚ùå Geen realtime data.";
          return;
        }

        const gps = [...matches].reverse().find(e => e.vehicle?.position);
        if (!gps) {
          realtime.innerHTML = "Geen GPS-positie.";
          return;
        }

        const v = gps.vehicle;

        realtime.innerHTML = `
          <p>
            <b>Latitude:</b> ${v.position.latitude}<br>
            <b>Longitude:</b> ${v.position.longitude}<br>
            <b>Richting:</b> ${v.position.bearing}¬∞
          </p>
        `;

        if (!map) initMap(v.position.latitude, v.position.longitude);
        map.setView([v.position.latitude, v.position.longitude], 15);

        if (marker)
          marker.setLatLng([v.position.latitude, v.position.longitude]);
        else
          marker = L.marker([v.position.latitude, v.position.longitude])
            .addTo(map)
            .bindPopup(`Voertuig ${id}`)
            .openPopup();

      } catch (err) {
        console.error(err);
        realtime.innerHTML = "‚ö†Ô∏è Fout bij realtime data.";
      }
    }
  </script>
</body>
</html>